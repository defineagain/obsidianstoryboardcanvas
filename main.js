var ct=Object.defineProperty;var Pt=Object.getOwnPropertyDescriptor;var Lt=Object.getOwnPropertyNames;var $t=Object.prototype.hasOwnProperty;var U=(s,t)=>()=>(s&&(t=s(s=0)),t);var mt=(s,t)=>{for(var e in t)ct(s,e,{get:t[e],enumerable:!0})},Ot=(s,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Lt(t))!$t.call(s,a)&&a!==e&&ct(s,a,{get:()=>t[a],enumerable:!(n=Pt(t,a))||n.enumerable});return s};var Rt=s=>Ot(ct({},"__esModule",{value:!0}),s);var L,$,H=U(()=>{L={layoutMode:"absolute",xScale:10,arcSpacing:500,nodeWidth:400,nodeHeight:300,nodeGapX:50,playbackSpeed:1500},$={dateParserRegex:"(?<y>-?\\d+)[-/.](?<M>\\d+)[-/.](?<d>\\d+)",dateParserGroupPriority:"y,M,d",dateDisplayFormat:"{y}-{M}-{d}",dateTokenConfiguration:[{name:"y",type:"NUMBER",minLeght:4,displayWhenZero:!0,hideSign:!1,formatting:[]},{name:"M",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]},{name:"d",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]}],applyAdditonalConditionFormatting:!1}});function Bt(s){return s.type==="NUMBER"}function _t(s){return s.type==="STRING"}function Gt(s,t,e){switch(s){case"GREATER":return t>e;case"LESS":return t<e;case"EQUAL":return t===e;case"NOTEQUAL":return t!==e;case"GREATEROREQUAL":return t>=e;case"LESSOREQUAL":return t<=e;default:return!1}}function Wt(s,t){let e=t.minLeght<0?0:t.minLeght,n=Math.abs(s).toString();for(;n.length<e;)n="0"+n;return!t.hideSign&&s<0&&(n=`-${n}`),n}function Yt(s,t){return t.dictionary[s]??String(s)}function Ut(s,t){if(Bt(t))return Wt(s,t);if(_t(t))return Yt(s,t);throw new Error("[Storyflow] Corrupted date token configuration")}function Ht(s,t,e,n){return n?e.formatting.reduce((a,o)=>(o.conditionsAreExclusive?o.evaluations.some.bind(o.evaluations):o.evaluations.every.bind(o.evaluations))(({condition:c,value:l})=>Gt(c,t,l))?o.format.replace("{value}",a):a,s):s}function M(s,t){let e=t.dateParserGroupPriority.split(","),n=t.dateDisplayFormat.toString();return e.forEach((a,o)=>{let r=a.trim(),i=t.dateTokenConfiguration.find(({name:c})=>c===r);if(!i)throw new Error(`[Storyflow] No date token configuration found for "${r}"`);n=n.replace(`{${r}}`,Ht(Ut(s[o],i),s[o],i,t.applyAdditonalConditionFormatting))}),n}function St(s,t){if(s.length<3||t.length<3)return"Later";let e=s[0]||0,n=s[1]||0,a=s[2]||0,o=t[0]||0,r=t[1]||0,i=t[2]||0,c=o-e,l=r-n,u=i-a;if(u<0&&(l-=1,u+=30),l<0&&(c-=1,l+=12),c===0&&l===0&&u===0)return"Same time";let d=[];return c>0&&d.push(`${c} year${c>1?"s":""}`),l>0&&d.push(`${l} month${l>1?"s":""}`),u>0&&d.push(`${u} day${u>1?"s":""}`),d.join(", ")+" later"}var q=U(()=>{H()});function O(s,t){let e=Math.max(s.length,t.length);for(let n=0;n<e;n++){let a=s[n]??0,o=t[n]??0;if(a!==o)return a-o}return 0}function tt(s){let t=[1,30,365,365e3,365e6],e=0;for(let n=0;n<s.length;n++){let a=s.length-1-n,o=t[a]??Math.pow(10,a+2);e+=(s[n]??0)*o}return e}function Ct(s,t=L){let e=new Map;if(s.length===0)return e;let n=[...s].sort((c,l)=>O(c.date,l.date)),a=n.map(c=>tt(c.date)),o=Math.min(...a),r=[];for(let c of n)r.includes(c.arc)||r.push(c.arc);let i=new Map;for(let c=0;c<n.length;c++){let l=n[c],u=r.indexOf(l.arc),d;if(t.layoutMode==="ordered")d=c*(t.nodeWidth+t.nodeGapX*2);else{d=(a[c]-o)*t.xScale;let g=i.get(l.arc);if(g!==void 0){let m=g+t.nodeWidth+t.nodeGapX;d<m&&(d=m)}i.set(l.arc,d)}let p=u*t.arcSpacing;e.set(l.nodeId,{x:d,y:p})}return e}function wt(s,t,e,n=L){if(t.length===0)return"Main Plot";let a=new Map;for(let i of t)if(!a.has(i.arc)){let l=t.filter(d=>d.arc===i.arc).map(d=>e.nodes.get(d.nodeId)?.y??0),u=l.length>0?l.reduce((d,p)=>d+p,0)/l.length:0;a.set(i.arc,u)}let o=Array.from(a.entries()).sort((i,c)=>i[1]-c[1]),r=Math.floor((s+n.arcSpacing/2)/n.arcSpacing);return r<0&&(r=0),r>=o.length?o[o.length-1][0]:o[r][0]}function Dt(s,t,e,n=L){if(t.length===0)return[new Date().getFullYear(),new Date().getMonth()+1,new Date().getDate()];if(n.layoutMode==="absolute"){let a=t.map(p=>tt(p.date)),o=Math.min(...a),r=s/n.xScale+o,i=[...t].sort((p,g)=>O(p.date,g.date)),c=i.filter(p=>tt(p.date)<=r),l=i.filter(p=>tt(p.date)>r),u=c.length>0?c[c.length-1]:null,d=l.length>0?l[0]:null;if(u&&d){let p=[...u.date];return p.length>0&&(p[p.length-1]=(p[p.length-1]??0)+1),p}if(u){let p=[...u.date];return p.length>0&&(p[p.length-1]=(p[p.length-1]??0)+1),p}if(d){let p=[...d.date];return p.length>0&&(p[p.length-1]=Math.max(1,(p[p.length-1]??2)-1)),p}}else{let a=t.map(l=>{let u=e.nodes.get(l.nodeId)?.x??0;return{...l,x:u}}).sort((l,u)=>l.x-u.x),o=n.nodeWidth+n.nodeGapX*2,r=Math.floor((s+o/2)/o);if(r<=0){let l=[...a[0].date];return l.length>0&&(l[l.length-1]=Math.max(1,(l[l.length-1]??2)-1)),l}if(r>=a.length){let l=[...a[a.length-1].date];return l.length>0&&(l[l.length-1]=(l[l.length-1]??0)+1),l}let c=[...a[r-1].date];return c.length>0&&(c[c.length-1]=(c[c.length-1]??0)+1),c}return[2e3,1,1]}var et=U(()=>{H()});async function k(s,t,e,n){await s.fileManager.processFrontMatter(t,a=>{a[e]=n})}function dt(s,t){let e=new Set,n=s.vault.getMarkdownFiles();for(let a of n){let o=s.metadataCache.getFileCache(a);if(!o?.frontmatter)continue;let r=o.frontmatter[t];typeof r=="string"&&r.trim()&&e.add(r.trim())}return[...e].sort()}function xt(s,t){new R(s,t,()=>{new K(s,t,()=>{new Q(s,t,()=>{new j(s,t).open()}).open()}).open()}).open()}var w,R,K,j,lt,Q,z=U(()=>{w=require("obsidian");R=class extends w.Modal{file;onComplete;value;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n;let a=t.app.metadataCache.getFileCache(e);this.value=a?.frontmatter?.["story-date"]?.toString()??""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Set date: ${this.file.basename}`}),new w.Setting(t).setName("Story date").setDesc("Format: YYYY-MM-DD (e.g. 2024-06-15) or fantasy format").addText(e=>{e.setPlaceholder("1000-03-15").setValue(this.value).onChange(n=>{this.value=n}),e.inputEl.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),this.save())}),setTimeout(()=>e.inputEl.focus(),50)}),new w.Setting(t).addButton(e=>e.setButtonText("Save").setCta().onClick(()=>this.save()))}async save(){let t=this.value.trim();if(!t){new w.Notice("Date cannot be empty.");return}let e=this.plugin.settings.dateSettings.dateParserRegex;if(!new RegExp(e).test(t)){new w.Notice(`Invalid date format. Needs to match regex:
${e}`);return}await k(this.app,this.file,"story-date",t),new w.Notice(`Set story-date: ${t}`),this.close(),this.onComplete()}onClose(){this.contentEl.empty()}},K=class extends w.SuggestModal{file;onComplete;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n,this.setPlaceholder("Type an arc name or select existing..."),this.setInstructions([{command:"\u2191\u2193",purpose:"navigate"},{command:"\u21B5",purpose:"select or create new"},{command:"esc",purpose:"cancel"}])}getSuggestions(t){let e=dt(this.app,"story-arc"),n=t.toLowerCase().trim(),a=e.filter(o=>o.toLowerCase().includes(n));return n&&!e.some(o=>o.toLowerCase()===n)&&a.unshift(`+ Create "${t.trim()}"`),a.length>0?a:[`+ Create "${t.trim()||"default"}"`]}renderSuggestion(t,e){e.createEl("span",{text:t})}async onChooseSuggestion(t){let e=t,n=t.match(/^\+ Create "(.+)"$/);n&&(e=n[1]),await k(this.app,this.file,"story-arc",e),new w.Notice(`Set story-arc: ${e}`),this.onComplete()}},j=class s extends w.SuggestModal{file;onComplete;plugin;allFiles;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n,this.allFiles=this.app.vault.getMarkdownFiles().filter(a=>a.path!==e.path),this.setPlaceholder("Select a file to depend on (or ESC to skip)...")}getSuggestions(t){let e=t.toLowerCase();return this.allFiles.filter(n=>n.basename.toLowerCase().includes(e))}renderSuggestion(t,e){e.createEl("div",{text:t.basename}),e.createEl("small",{text:t.path,cls:"storyflow-subtext"})}async onChooseSuggestion(t){new lt(this.plugin,this.file,t.basename,()=>{new s(this.plugin,this.file,this.onComplete).open()}).open()}onClose(){super.onClose(),setTimeout(()=>{document.querySelector(".modal-container")||this.onComplete()},100)}},lt=class extends w.Modal{file;targetBasename;onComplete;constructor(t,e,n,a){super(t.app),this.file=e,this.targetBasename=n,this.onComplete=a}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Dependency: ${this.targetBasename}`}),t.createEl("p",{text:`Does "${this.targetBasename}" happen BEFORE or AFTER "${this.file.basename}"?`});let e=t.createDiv({cls:"storyflow-flex-row"});e.createEl("button",{text:"Happens BEFORE"}).addEventListener("click",async o=>{o.preventDefault(),await this.saveDependency("before"),this.close()}),e.createEl("button",{text:"Happens AFTER"}).addEventListener("click",async o=>{o.preventDefault(),await this.saveDependency("after"),this.close()})}async saveDependency(t){let e=`${this.targetBasename}:${t}`;await this.app.fileManager.processFrontMatter(this.file,r=>{let i=r["story-deps"]||[];Array.isArray(i)||(i=[i]),i.includes(e)||(i=[...i,e]),r["story-deps"]=i});let n=t==="before"?"after":"before",a=`${this.file.basename}:${n}`,o=this.app.vault.getMarkdownFiles().find(r=>r.basename===this.targetBasename);o?(await this.app.fileManager.processFrontMatter(o,r=>{let i=r["story-deps"]||[];Array.isArray(i)||(i=[i]),i.includes(a)||(i=[...i,a]),r["story-deps"]=i}),new w.Notice(`Linked: ${this.file.basename} & ${this.targetBasename}`)):new w.Notice(`Added one-way dependency: ${e}`)}onClose(){this.contentEl.empty(),this.onComplete()}},Q=class extends w.Modal{file;onComplete;value=5;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n;let o=t.app.metadataCache.getFileCache(e)?.frontmatter?.tension;typeof o=="number"&&o>=1&&o<=10&&(this.value=o)}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Set tension: ${this.file.basename}`});let e=t.createEl("div",{text:`Level: ${this.value}`});e.style.textAlign="center",e.style.fontSize="1.2em",e.style.fontWeight="bold",e.style.marginBottom="12px",new w.Setting(t).setName("Pacing / Dramatic Tension").setDesc("1 (Calm) to 10 (High Action)").addSlider(n=>{n.setLimits(1,10,1).setValue(this.value).setDynamicTooltip().onChange(a=>{this.value=a,e.setText(`Level: ${a}`)})}),new w.Setting(t).addButton(n=>n.setButtonText("Save").setCta().onClick(()=>this.save()))}async save(){await k(this.app,this.file,"tension",this.value),new w.Notice(`Set tension: ${this.value}`),this.close(),this.onComplete()}onClose(){this.contentEl.empty()}}});var Et={};mt(Et,{SyncConfirmationModal:()=>pt,calculateSyncChanges:()=>Xt});async function Xt(s,t,e,n,a){let o=[],r=new Map;for(let u of e){let d=t.nodes.get(u.nodeId);d&&(r.has(u.arc)||r.set(u.arc,[]),r.get(u.arc).push(d.getData().y))}let i=new Map;for(let[u,d]of r.entries()){let p=d.reduce((g,m)=>g+m,0)/d.length;i.set(u,p)}let l=Array.from(t.nodes.entries()).map(([u,d])=>({id:u,data:d.getData()})).filter(u=>u.data.type==="file"&&u.data.file).sort((u,d)=>u.data.x-d.data.x).map(u=>u.id);for(let u of e){let d=t.nodes.get(u.nodeId);if(!d)continue;let p=d.getData(),g=!1,m,v,b=[],E=u.arc,F=1/0;for(let[C,D]of i.entries()){let J=Math.abs(p.y-D);J<F&&(F=J,E=C)}E!==u.arc&&F<n.arcSpacing/2&&(m=E,b.push(`Arc changed from "${u.arc}" to "${m}"`),g=!0);let G=l.indexOf(u.nodeId),W=l[G-1],ft=l[G+1],S=e.find(C=>C.nodeId===W),I=e.find(C=>C.nodeId===ft),P=!1;if(S&&O(u.date,S.date)<=0&&(P=!0),I&&O(u.date,I.date)>=0&&(P=!0),P){let C=[...u.date],D=C.length-1;S&&I?(C[D]=Math.floor((S.date[D]+I.date[D])/2),C[D]<=S.date[D]&&(C[D]=S.date[D]+1)):S?C[D]=S.date[D]+1:I&&(C[D]=I.date[D]-1),v=C,b.push(`Sequence moved: expected bounds broken. Suggesting new date: ${M(v,a)}`),g=!0}g&&o.push({scene:u,newArc:m,newDate:v,description:b.join("; ")})}return o}var B,pt,Tt=U(()=>{B=require("obsidian");q();et();z();pt=class extends B.Modal{changes;dateSettings;onConfirm;constructor(t,e,n,a){super(t),this.changes=e,this.dateSettings=n,this.onConfirm=a}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:`Sync ${this.changes.length} Changes to Notes`}),t.createEl("p",{text:"The following frontmatter updates will be applied based on your canvas dragging:"});let e=t.createEl("ul",{cls:"storyflow-sync-list"});for(let n of this.changes){let a=e.createEl("li");a.createEl("strong",{text:n.scene.title+": "}),a.createEl("span",{text:n.description})}new B.Setting(t).addButton(n=>n.setButtonText("Cancel").onClick(()=>this.close())).addButton(n=>n.setButtonText("Apply Changes").setCta().onClick(async()=>{this.close();let a=0;for(let o of this.changes){if(o.newArc&&await k(this.app,o.scene.file,"story-arc",o.newArc),o.newDate){let r=M(o.newDate,this.dateSettings);await k(this.app,o.scene.file,"story-date",r)}a++}new B.Notice(`Successfully synced ${a} notes from canvas.`),this.onConfirm()}))}onClose(){this.contentEl.empty()}}});var Kt={};mt(Kt,{default:()=>rt});module.exports=Rt(Kt);var Nt=require("obsidian");var x=require("obsidian");H();function yt(s,t,e){if(s.frontmatter)return typeof s.frontmatter[t]===e?s.frontmatter[t]:void 0}function Vt(s,t,e){try{let n=new RegExp(e).exec(t);if(!n?.groups)return;let a=[];for(let o of s){let r=n.groups[o.trim()];if(r===void 0)return;let i=parseInt(r,10);if(isNaN(i))return;a.push(i)}return a}catch{return}}function X(s,t,e){if(!s.frontmatter)return;let n=s.frontmatter[t];if(n==null)return;let a=e.dateParserGroupPriority.split(",");if(typeof n=="number"){let p=[...Array(Math.max(0,a.length-1))].map(()=>1);return[n,...p]}if(n instanceof Date)return[n.getFullYear(),n.getMonth()+1,n.getDate()];if(typeof n=="object"&&typeof n.toISOString=="function")try{let p=new Date(n.toISOString());return[p.getFullYear(),p.getMonth()+1,p.getDate()]}catch{}let o;typeof n=="string"?o=n.trim():o=String(n).trim();let r=o.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);if(r)return[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10)];let i=o.match(/^(-?\d+)\/(\d{1,2})\/(\d{1,2})/);if(i)return[parseInt(i[1],10),parseInt(i[2],10),parseInt(i[3],10)];let c=o.match(/^(-?\d+)\.(\d{1,2})\.(\d{1,2})/);if(c)return[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)];let l=o.match(/\w+ (\w+) (\d+) (\d{4})/);if(l){let g={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[l[1]];if(g)return[parseInt(l[3],10),g,parseInt(l[2],10)]}let u=o.replace(/[/.]/g,"-"),d=Vt(a,u,e.dateParserRegex);if(d)return d;console.warn(`[Storyboard Canvas] Could not parse '${t}' value:`,n,`(type: ${typeof n})`)}function vt(s,t="story-arc"){return yt(s,t,"string")??"default"}function bt(s,t="story-title"){return yt(s,t,"string")??""}q();et();function At(s=16){return Math.random().toString(36).substring(2,2+s/2)+Math.random().toString(36).substring(2,2+s/2)}var nt=class{app;dateSettings;layoutConfig;constructor(t,e=$,n=L){this.app=t,this.layoutConfig=n,this.dateSettings=e}getActiveCanvas(){let t=this.app.workspace.getLeavesOfType("canvas");return t.length===0?null:t[0].view.canvas??null}async extractScenes(t){let e=[];for(let[n,a]of t.nodes){let o=a.getData();if(o.type!=="file"||!o.file)continue;let r=this.app.vault.getAbstractFileByPath(o.file);if(!(r instanceof x.TFile))continue;let i=this.app.metadataCache.getFileCache(r);if(!i){console.warn(`[Storyboard] No metadata cache for: ${r.path}`);continue}let c=i.frontmatter?.["story-date"];if(c==null){console.log(`[Storyboard] Skipping ${r.basename}: no story-date in frontmatter`);continue}console.log(`[Storyboard] ${r.basename}: story-date raw =`,c,`(type: ${typeof c}, isDate: ${c instanceof Date})`);let l=X(i,"story-date",this.dateSettings);if(!l){console.warn(`[Storyboard] FAILED to parse story-date for: ${r.basename}, raw value:`,c);continue}let u=X(i,"story-end-date",this.dateSettings),d=vt(i),p=bt(i)||r.basename,g=i.frontmatter?.["story-deps"],m=[];if(Array.isArray(g)){for(let E of g)if(typeof E=="string"){let F=E.split(":");F.length===2&&(F[1]==="before"||F[1]==="after")&&m.push({basename:F[0],type:F[1]})}}let v=i.frontmatter?.tension,b;typeof v=="number"&&v>=1&&v<=10&&(b=v),console.log(`[Storyboard] \u2713 ${r.basename}: date=[${l}], arc="${d}", tension=${b}`),e.push({nodeId:n,file:r,date:l,endDate:u,arc:d,title:p,tension:b,deps:m})}return e}async sortStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new x.Notice("No scenes with story-date found on this canvas.");return}let n=Ct(e,this.layoutConfig);for(let[a,o]of n){let r=t.nodes.get(a);if(!r)continue;let i=r.getData();r.setData({...i,x:o.x,y:o.y,width:this.layoutConfig.nodeWidth,height:this.layoutConfig.nodeHeight});let c=e.find(l=>l.nodeId===a);if(r.nodeEl){for(let l=1;l<=10;l++)r.nodeEl.classList.remove(`storyboard-tension-${l}`);c?.tension&&r.nodeEl.classList.add(`storyboard-tension-${Math.floor(c.tension)}`)}}t.requestSave(),new x.Notice(`Sorted ${e.length} scenes by date.`)}async connectChronologically(t){let e=await this.extractScenes(t);if(e.length<2){new x.Notice("Need at least 2 scenes with story-date to connect.");return}let n=new Map;for(let r of e){let i=n.get(r.arc)??[];i.push(r),n.set(r.arc,i)}let a=0,o=t.getData();for(let[,r]of n){r.sort((i,c)=>O(i.date,c.date));for(let i=0;i<r.length-1;i++){let c=r[i],l=r[i+1];if(o.edges.some(p=>p.fromNode===c.nodeId&&p.toNode===l.nodeId))continue;let d=St(c.date,l.date);o.edges.push({id:At(),fromNode:c.nodeId,toNode:l.nodeId,fromSide:"right",toSide:"left",toEnd:"arrow",label:d}),a++}}a>0&&(t.setData(o),t.requestSave()),new x.Notice(`Connected ${a} scene pairs across ${n.size} arc(s).`)}async connectByLinks(t){let e=this.app.metadataCache.resolvedLinks,n=t.getData(),a=new Map;for(let[i,c]of t.nodes){let l=c.getData();l.type==="file"&&l.file&&a.set(l.file,i)}let o=new Set;for(let i of n.edges)o.add(`${i.fromNode}->${i.toNode}`);let r=0;for(let[i,c]of a){let l=e[i];if(l)for(let u in l){let d=a.get(u);if(!d||d===c)continue;let p=`${c}->${d}`;o.has(p)||(n.edges.push({id:At(),fromNode:c,toNode:d,fromSide:"bottom",toSide:"top",toEnd:"arrow",styleAttributes:{"edge-style":"dotted"}}),o.add(p),r++)}}r>0&&(t.setData(n),t.requestSave()),new x.Notice(`Created ${r} cross-link edges from [[wikilinks]].`)}async buildStoryboard(t){let e=t.nodes.size,n=await this.extractScenes(t),a=e-n.length;if(n.length===0){new x.Notice(`No scenes found. ${e} nodes on canvas but none have story-date frontmatter. Use "Tag scene" command on each note first.`);return}a>0&&new x.Notice(`Found ${n.length} tagged scenes (${a} nodes skipped \u2014 no story-date).`),this.removeMarkerNodes(t),await this.sortStoryboard(t),await this.connectChronologically(t),await this.connectByLinks(t),this.addVisualMarkers(t,n),new x.Notice(`Storyboard built: ${n.length} scenes, sorted + connected + labelled.`)}MARKER_PREFIX="storyboard-marker-";removeMarkerNodes(t){let e=t.getData();e.nodes=e.nodes.filter(n=>!n.id?.startsWith(this.MARKER_PREFIX)),t.setData(e),t.requestSave()}addVisualMarkers(t,e){let n=t.getData(),a=new Map,o=new Map;for(let m of e){let v=t.nodes.get(m.nodeId);if(!v)continue;let b=v.getData();a.has(m.arc)||a.set(m.arc,b.y);let E=M(m.date,this.dateSettings);o.has(E)||o.set(E,b.x)}let r=200,i=60,c=Math.min(...a.values())-i-80,u=Math.min(...o.values())-r-60,d=0;for(let[m,v]of a){let b=["1","2","3","4","5","6"];n.nodes.push({id:`${this.MARKER_PREFIX}arc-${d}`,type:"text",text:`## ${m}`,x:u,y:v+this.layoutConfig.nodeHeight/2-i/2,width:r,height:i,color:b[d%b.length]}),d++}let p=0;for(let[m,v]of o)n.nodes.push({id:`${this.MARKER_PREFIX}date-${p}`,type:"text",text:`**${m}**`,x:v+this.layoutConfig.nodeWidth/2-r/2,y:c,width:r,height:i,color:"0"}),p++;let g=40;for(let m of e){let v=t.nodes.get(m.nodeId);if(!v)continue;let b=v.getData(),E=M(m.date,this.dateSettings);n.nodes.push({id:`${this.MARKER_PREFIX}nodelabel-${m.nodeId}`,type:"text",text:E,x:b.x,y:b.y-g-10,width:this.layoutConfig.nodeWidth,height:g,color:"0"})}t.setData(n),t.requestSave()}async syncStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new x.Notice("No scenes with story-date found.");return}let{calculateSyncChanges:n,SyncConfirmationModal:a}=await Promise.resolve().then(()=>(Tt(),Et)),o=await n(this.app,t,e,this.layoutConfig,this.dateSettings);if(o.length===0){new x.Notice("No drag-and-drop changes detected.");return}new a(this.app,o,this.dateSettings,()=>{this.buildStoryboard(t)}).open()}async playStoryboard(t,e){let n=e??this.layoutConfig.playbackSpeed??1500,a=await this.extractScenes(t);if(a.length===0){new x.Notice("No scenes with story-date found.");return}a.sort((o,r)=>O(o.date,r.date)),new x.Notice(`Playing ${a.length} scenes...`);for(let o of a){let r=t.nodes.get(o.nodeId);if(!r)continue;let i=r.getData();t.zoomToBbox({minX:i.x-50,minY:i.y-50,maxX:i.x+i.width+50,maxY:i.y+i.height+50}),await new Promise(c=>setTimeout(c,n))}new x.Notice("Playback complete.")}};z();var N=require("obsidian");H();var Mt={layoutConfig:L,dateSettings:$},at=class extends N.PluginSettingTab{plugin;constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Storyboard Canvas Settings"}),new N.Setting(t).setName("Layout Mode").setDesc("Absolute: position nodes strictly by time elapsed on X-axis. Ordered: distribute nodes evenly in sequence on X-axis.").addDropdown(e=>e.addOption("absolute","Absolute Time Graph").addOption("ordered","Ordered Sequence").setValue(this.plugin.settings.layoutConfig.layoutMode).onChange(async n=>{this.plugin.settings.layoutConfig.layoutMode=n,await this.plugin.saveSettings()})),new N.Setting(t).setName("Date Parser Regex").setDesc("Regex with named capture groups (?<y>, ?<M>, ?<d>) to extract dates from story-date.").addText(e=>e.setPlaceholder($.dateParserRegex).setValue(this.plugin.settings.dateSettings.dateParserRegex).onChange(async n=>{this.plugin.settings.dateSettings.dateParserRegex=n.trim()||$.dateParserRegex,await this.plugin.saveSettings()})),new N.Setting(t).setName("Date Display Format").setDesc("How dates appear on canvas labels. Use {y}, {M}, {d}.").addText(e=>e.setPlaceholder($.dateDisplayFormat).setValue(this.plugin.settings.dateSettings.dateDisplayFormat).onChange(async n=>{this.plugin.settings.dateSettings.dateDisplayFormat=n.trim()||$.dateDisplayFormat,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Layout Dimensions"}),new N.Setting(t).setName("X Scale (Absolute Mode)").setDesc("Pixels per date ordinal unit in absolute time graph mode.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.xScale)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.xScale=a,await this.plugin.saveSettings())})),new N.Setting(t).setName("Arc Lane Spacing (Y-Axis)").setDesc("Pixels between arc lanes on the Y-axis.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.arcSpacing)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.arcSpacing=a,await this.plugin.saveSettings())})),new N.Setting(t).setName("Playback Speed (ms)").setDesc("Milliseconds between scenes during animated playback.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.playbackSpeed)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.playbackSpeed=a,await this.plugin.saveSettings())}))}};var A=require("obsidian");q();z();var V="storyboard-inspector-view",_=class extends A.ItemView{plugin;pollInterval=null;activeNodeId=null;showConstraintWindow=!1;container;contentDiv;constructor(t,e){super(t),this.plugin=e}getViewType(){return V}getDisplayText(){return"Storyboard Inspector"}getIcon(){return"list"}async onOpen(){let{containerEl:t}=this;t.empty(),t.addClass("storyboard-inspector-view");let e=t.createEl("h3",{text:"Storyboard Inspector",cls:"storyboard-inspector-title"});this.container=t.createDiv({cls:"inspector-content"}),this.renderEmptyState(),this.pollInterval=window.setInterval(()=>this.pollSelection(),300),this.registerEvent(this.app.metadataCache.on("changed",n=>{if(!this.activeNodeId||this.container?.contains(document.activeElement))return;let a=this.plugin.canvasManager.getActiveCanvas();if(!a)return;let o=a.nodes.get(this.activeNodeId);o&&o.getData().type==="file"&&o.file?.path===n.path&&setTimeout(()=>this.renderInspector(o),50)}))}async onClose(){this.pollInterval!==null&&(window.clearInterval(this.pollInterval),this.pollInterval=null),this.container.empty()}renderEmptyState(){this.container.empty(),this.container.createEl("p",{text:"Select a single file node on the canvas to inspect it.",cls:"empty-state"}),this.activeNodeId=null,this.showConstraintWindow=!1,this.clearConstraintOverlays()}pollSelection(){if(this.container?.contains(document.activeElement))return;let t=this.plugin.canvasManager.getActiveCanvas();if(!t){this.activeNodeId!==null&&this.renderEmptyState();return}let e=Array.from(t.selection);if(e.length!==1){this.activeNodeId!==null&&this.renderEmptyState();return}let n=e[0];if(n.getData().type!=="file"||!n.file){this.activeNodeId!==null&&this.renderEmptyState();return}let a=n.getData().id;this.activeNodeId!==a&&(this.activeNodeId=a,this.renderInspector(n))}async renderInspector(t){if(this.container.empty(),this.clearConstraintOverlays(),!t.file)return;let e=this.container.createDiv({cls:"storyboard-inspector-inner"}),n=e.createDiv({cls:"storyboard-inspector-header"});n.createEl("h3",{text:t.file.basename}),n.createEl("div",{text:"Storyboard Node",cls:"storyflow-subtext"});let a=this.app.metadataCache.getFileCache(t.file),o=a?.frontmatter||{},r=o["story-arc"]?.toString()||"",i=o["story-date"]?.toString()||"",c=5;typeof o.tension=="number"&&o.tension>=1&&o.tension<=10&&(c=o.tension);let l=X(a,"story-date",this.plugin.settings.dateSettings);l&&(i=M(l,this.plugin.settings.dateSettings));let u=o["story-deps"],d=[];if(Array.isArray(u)){for(let f of u)if(typeof f=="string"){let y=f.split(":");y.length===2&&(y[1]==="before"||y[1]==="after")&&d.push({basename:y[0],type:y[1]})}}let p=null,g=null,m="-\u221E",v="+\u221E",b=this.plugin.canvasManager.getActiveCanvas();if(b)try{let f=await this.plugin.canvasManager.extractScenes(b);if(r){let y=f.filter(T=>T.arc===r).sort((T,Y)=>this.compareAbstractDates(T.date,Y.date)),h=y.findIndex(T=>T.nodeId===t.getData().id);if(h!==-1){let T=h>0?y[h-1]:null,Y=h<y.length-1?y[h+1]:null;T&&(p=T.date,m=`${T.title} (Arc)`),Y&&(g=Y.date,v=`${Y.title} (Arc)`)}}for(let y of d){let h=f.find(T=>T.file.basename===y.basename);h&&(y.type==="after"?(!p||this.compareAbstractDates(h.date,p)>0)&&(p=h.date,m=`${h.title} (Dep)`):y.type==="before"&&(!g||this.compareAbstractDates(h.date,g)<0)&&(g=h.date,v=`${h.title} (Dep)`))}}catch{}let E=p?M(p,this.plugin.settings.dateSettings):"-\u221E",F=g?M(g,this.plugin.settings.dateSettings):"+\u221E",G="Allowed Window: Any date";(p||g)&&(G=`Allowed: ${E} \u2794 ${F}
Bounded by: [${m}] and [${v}]`);let W=e.createDiv({cls:"storyflow-inspector-card"});W.createEl("h4",{text:"Timeline Nudge",cls:"timeline-slider-header"}),W.createEl("p",{text:"Slide left/right to move the node on the timeline. Release to sync changes to frontmatter.",cls:"setting-item-description"});let S=W.createDiv({cls:"timeline-slider-container"}).createEl("input",{cls:"storyflow-nudge-slider"});S.type="range",S.style.width="100%";let I=t.x;S.min=(I-1e3).toString(),S.max=(I+1e3).toString(),S.value=I.toString(),S.addEventListener("input",()=>{let f=parseInt(S.value,10);t.setData({...t.getData(),x:f}),b&&b.requestSave()}),S.addEventListener("change",async()=>{let f=t.x;S.min=(f-1e3).toString(),S.max=(f+1e3).toString(),S.value=f.toString(),new A.Notice("Slider released. Updating node date..."),b&&await this.plugin.canvasManager.syncStoryboard(b)});let P=e.createDiv({cls:"storyflow-inspector-card"});P.createEl("h4",{text:"Properties"});let C=new A.Setting(P).setName("Story Arc").setDesc("Which lane or plotline this scene belongs to."),D=()=>{C.clear(),C.setName("Story Arc").setDesc("Which lane or plotline this scene belongs to."),C.addDropdown(f=>{let y=dt(this.app,"story-arc");f.addOption("","-- Select an Arc --"),y.forEach(h=>f.addOption(h,h)),f.addOption("__CREATE__","+ Create New Arc..."),y.includes(r)?f.setValue(r):r&&(f.addOption(r,r),f.setValue(r)),f.onChange(async h=>{if(h==="__CREATE__"){J();return}h!==r&&await k(this.app,t.file,"story-arc",h)})})},J=()=>{C.clear(),C.setName("New Story Arc").setDesc("Type a new lane name, then press Enter."),C.addText(f=>{f.setPlaceholder("e.g. Subplot B");let y=async()=>{let h=f.getValue().trim();h&&h!==r&&await k(this.app,t.file,"story-arc",h)};f.inputEl.addEventListener("blur",y),f.inputEl.addEventListener("keydown",h=>{h.key==="Enter"&&(y(),f.inputEl.blur(),setTimeout(()=>{this.pollSelection()},50)),h.key==="Escape"&&D()}),setTimeout(()=>f.inputEl.focus(),50)})};D(),new A.Setting(P).setName("Story Date").setDesc(G).addText(f=>{f.setValue(i).setPlaceholder("YYYY-MM-DD");let y=async()=>{let h=f.getValue();if(h!==i){let T=this.plugin.settings.dateSettings.dateParserRegex;new RegExp(T).test(h)?await k(this.app,t.file,"story-date",h):new A.Notice("Invalid date format for Storyboard")}};f.inputEl.addEventListener("blur",y),f.inputEl.addEventListener("keydown",h=>{h.key==="Enter"&&(y(),f.inputEl.blur())})});let gt=P.createDiv(),it=gt.createEl("div",{text:`Tension Level: ${c}`});it.style.fontWeight="bold",it.style.marginBottom="4px",new A.Setting(gt).setName("Dramatic Tension").setDesc("1 (Calm) to 10 (High Action)").addSlider(f=>{f.setLimits(1,10,1).setValue(c).setDynamicTooltip().onChange(async y=>{c=y,it.setText(`Tension Level: ${y}`),await k(this.app,t.file,"tension",y),b&&this.plugin.canvasManager.sortStoryboard(b)})});let ht=e.createDiv({cls:"storyflow-inspector-card"});ht.createEl("h4",{text:"Dependencies"});let jt=new A.Setting(ht).addButton(f=>f.setButtonText("Show Dependencies").setTooltip("View and delete active dependencies").onClick(()=>{new ut(this.app,this.plugin,t,t.file,d,()=>{this.renderInspector(t)}).open()})).addButton(f=>f.setButtonText("+ Add Dependency").setCta().onClick(()=>{new j(this.plugin,t.file,()=>{this.renderInspector(t)}).open()}))}compareAbstractDates(t,e){let n=Math.max(t.length,e.length);for(let a=0;a<n;a++){let o=t[a]||0,r=e[a]||0;if(o!==r)return o-r}return 0}clearConstraintOverlays(){document.querySelectorAll(".storyflow-constraint-overlay").forEach(t=>t.remove())}renderConstraintOverlays(t,e,n){if(!t)return;this.clearConstraintOverlays();let a=t.nodeEl;if(!a)return;if(e!==-1/0){let c=document.createElement("div");c.addClasses(["storyflow-constraint-overlay","invalid"]),Object.assign(c.style,{left:"-100000px",width:`${1e5+e}px`}),a.appendChild(c)}if(n!==1/0){let c=document.createElement("div");c.addClasses(["storyflow-constraint-overlay","invalid"]),Object.assign(c.style,{left:`${n}px`,width:"100000px"}),a.appendChild(c)}let o=e===-1/0?-1e5:e,r=n===1/0?1e5:n,i=document.createElement("div");i.addClasses(["storyflow-constraint-overlay","valid"]),Object.assign(i.style,{left:`${o}px`,width:`${r-o}px`}),a.appendChild(i)}},ut=class extends A.Modal{plugin;sourceFile;node;currentDeps;onComplete;constructor(t,e,n,a,o,r){super(t),this.plugin=e,this.node=n,this.sourceFile=a,this.currentDeps=o,this.onComplete=r}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:`Dependencies for ${this.sourceFile.basename}`});let e=t.createDiv({cls:"storyboard-deps-list"});e.style.maxHeight="400px",e.style.padding="10px",e.style.overflowY="auto",this.currentDeps.length===0?e.createEl("p",{text:"No dependencies set. Use the Add Dependency button to create one.",cls:"storyflow-subtext"}):this.currentDeps.forEach(n=>{let a=e.createEl("div",{cls:`storyflow-dep-tag dep-${n.type}`});a.style.marginBottom="8px",a.style.display="flex",a.style.justifyContent="space-between",a.style.alignItems="center",a.setText(`${n.type==="before"?"Before:":"After:"} ${n.basename}`);let o=a.createEl("span",{text:"\u2715",cls:"storyflow-dep-remove clickable-icon"});o.style.marginLeft="10px",o.style.color="var(--text-error)",o.style.fontWeight="bold",o.style.cursor="pointer",o.addEventListener("click",async r=>{r.stopPropagation();let i=`${n.basename}:${n.type}`,c=n.type==="before"?"after":"before",l=`${this.sourceFile.basename}:${c}`;await this.app.fileManager.processFrontMatter(this.sourceFile,d=>{let p=d["story-deps"];Array.isArray(p)&&(d["story-deps"]=p.filter(g=>g!==i),d["story-deps"].length===0&&delete d["story-deps"])});let u=this.app.vault.getMarkdownFiles().find(d=>d.basename===n.basename);u&&await this.app.fileManager.processFrontMatter(u,d=>{let p=d["story-deps"];Array.isArray(p)&&(d["story-deps"]=p.filter(g=>g!==l),d["story-deps"].length===0&&delete d["story-deps"])}),new A.Notice(`Removed dependency: ${n.basename}`),this.currentDeps=this.currentDeps.filter(d=>d.basename!==n.basename),this.onOpen()})})}onClose(){let{contentEl:t}=this;t.empty(),this.onComplete()}};function Z(s,t){let e=Object.keys(t).map(n=>qt(s,n,t[n]));return e.length===1?e[0]:function(){e.forEach(n=>n())}}function qt(s,t,e){let n=s[t],a=s.hasOwnProperty(t),o=a?n:function(){return Object.getPrototypeOf(s)[t].apply(this,arguments)},r=e(o);return n&&Object.setPrototypeOf(r,n),Object.setPrototypeOf(i,r),s[t]=i,c;function i(...l){return r===o&&s[t]===i&&c(),r.apply(this,l)}function c(){s[t]===i&&(a?s[t]=o:delete s[t]),r!==o&&(r=o,Object.setPrototypeOf(i,n||Function))}}var Ft=require("obsidian");z();function kt(s,t){let e=t.canvasManager.getActiveCanvas();if(!e)return;let n=Array.from(e.selection);if(n.length!==1)return;let a=n[0];if(a.getData().type!=="file"||!a.file||s.querySelector(".storyboard-menu-btn"))return;let o=document.createElement("button");o.addClass("clickable-icon"),o.addClass("canvas-node-menu-item"),o.addClass("storyboard-menu-btn"),o.setAttribute("aria-label","Set story-date"),(0,Ft.setIcon)(o,"calendar"),o.addEventListener("click",()=>{new R(t,a.file).open()}),s.appendChild(o)}var ot=require("obsidian");et();q();async function st(s,t,e){let n=await s.canvasManager.extractScenes(t),a=wt(e.y,n,t,s.settings.layoutConfig),o=Dt(e.x,n,t,s.settings.layoutConfig),r=M(o,s.settings.dateSettings),i=1,c=`Untitled Scene ${i}.md`,l="/",u=s.app.workspace.getLeavesOfType("canvas")[0]?.view;for(u&&u.file&&(l=u.file.parent.path,l!=="/"&&(l+="/"));s.app.vault.getAbstractFileByPath(`${l}${c}`);)i++,c=`Untitled Scene ${i}.md`;let d=`---
story-arc: "${a}"
story-date: ${r}
---

`;try{let p=await s.app.vault.create(`${l}${c}`,d);if(t.createFileNode){let g=t.createFileNode({file:p,pos:e,size:{width:s.settings.layoutConfig.nodeWidth,height:s.settings.layoutConfig.nodeHeight},save:!0,focus:!0});t.addNode(g),t.requestSave(),t.deselectAll(),t.selection.add(g),t.requestSave(),t.zoomToSelection(),new ot.Notice(`Created new scene in '${a}' on ${r}`)}else new ot.Notice("Error: Canvas API is missing createFileNode.")}catch(p){console.error("[Storyboard] Ghost Node generation failed:",p),new ot.Notice("Failed to create Ghost Node.")}}function It(s){let t=!1,e=()=>{if(t)return;let a=s.app.workspace.getLeavesOfType("canvas")?.[0]?.view;if(!a||!a.canvas)return;let o=Object.getPrototypeOf(a.canvas);o&&(o.onDoubleClick&&s.register(Z(o,{onDoubleClick:r=>function(i){if(i.shiftKey){i.stopPropagation(),i.preventDefault();let c=this.posFromEvt(i);st(s,this,c);return}return r.call(this,i)}})),o.onContextMenu&&s.register(Z(o,{onContextMenu:r=>function(i){if(i.shiftKey){i.stopPropagation(),i.preventDefault();let c=this.posFromEvt(i);st(s,this,c);return}return r.call(this,i)}})),o.requestSave&&s.register(Z(o,{requestSave:r=>function(...i){let c=r.call(this,...i);if(!t){let u=this.nodes?.values()?.next()?.value;if(u){let d=Object.getPrototypeOf(Object.getPrototypeOf(u));d&&d.showMenu&&(s.register(Z(d,{showMenu:p=>function(...g){let m=p.call(this,...g);return setTimeout(()=>{let v=document.body.querySelector(".canvas-node-menu");v&&kt(v,s)},0),m}})),t=!0,s.app.workspace.offref(n))}}let l=s.app.workspace.getLeavesOfType(V);for(let u of l)u.view instanceof _&&u.view.pollSelection();return c}})),!o.onContextMenu&&!s.__globalContextMenuBound&&(s.__globalContextMenuBound=!0,s.registerDomEvent(window,"contextmenu",r=>{if(r.shiftKey){let i=s.app.workspace.getLeavesOfType("canvas")?.[0]?.view;if(i&&i.canvas&&i.canvas.canvasEl.contains(r.target)&&r.target.hasClass("canvas-wrapper")){r.stopPropagation(),r.preventDefault();let c=i.canvas.posFromEvt(r);st(s,i.canvas,c)}}},{capture:!0})))};s.app.workspace.onLayoutReady(e);let n=s.app.workspace.on("active-leaf-change",e);s.registerEvent(n)}var rt=class extends Nt.Plugin{canvasManager;settings;async onload(){await this.loadSettings(),this.canvasManager=new nt(this.app,this.settings.dateSettings,this.settings.layoutConfig),this.addSettingTab(new at(this.app,this)),this.registerView(V,t=>new _(t,this)),this.addRibbonIcon("list","Open Storyboard Inspector",()=>{this.activateInspectorView()}),It(this),this.addCommand({id:"storyboard-set-date",name:"Set story date on current note",editorCallback:(t,e)=>{e.file&&new R(this,e.file).open()}}),this.addCommand({id:"storyboard-set-arc",name:"Set story arc on current note",editorCallback:(t,e)=>{e.file&&new K(this,e.file).open()}}),this.addCommand({id:"storyboard-set-tension",name:"Set story tension (1-10) on current note",editorCallback:(t,e)=>{e.file&&new Q(this,e.file).open()}}),this.addCommand({id:"storyboard-tag-scene",name:"Tag scene (set date + arc)",editorCallback:(t,e)=>{e.file&&xt(this,e.file)}}),this.addCommand({id:"storyboard-build",name:"Build storyboard (sort + connect + cross-link)",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.buildStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sort",name:"Sort storyboard by date",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.sortStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-connect",name:"Connect scenes chronologically",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectChronologically(e),!0):!1}}),this.addCommand({id:"storyboard-crosslink",name:"Add cross-link edges from [[wikilinks]]",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectByLinks(e),!0):!1}}),this.addCommand({id:"storyboard-play",name:"Play storyboard",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.playStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sync",name:"Sync canvas to notes",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.syncStoryboard(e),!0):!1}})}async loadSettings(){this.settings=Object.assign({},Mt,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.canvasManager&&(this.canvasManager.dateSettings=this.settings.dateSettings,this.canvasManager.layoutConfig=this.settings.layoutConfig)}async activateInspectorView(){let{workspace:t}=this.app,e=null,n=t.getLeavesOfType(V);n.length>0?e=n[0]:(e=t.getRightLeaf(!1),e&&await e.setViewState({type:V,active:!0})),e&&t.revealLeaf(e)}onunload(){}};
