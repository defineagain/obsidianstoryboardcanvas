var q=Object.defineProperty;var ft=Object.getOwnPropertyDescriptor;var mt=Object.getOwnPropertyNames;var ht=Object.prototype.hasOwnProperty;var P=(s,t)=>()=>(s&&(t=s(s=0)),t);var Z=(s,t)=>{for(var e in t)q(s,e,{get:t[e],enumerable:!0})},yt=(s,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of mt(t))!ht.call(s,a)&&a!==e&&q(s,a,{get:()=>t[a],enumerable:!(n=ft(t,a))||n.enumerable});return s};var vt=s=>yt(q({},"__esModule",{value:!0}),s);var N,w,R=P(()=>{N={layoutMode:"absolute",xScale:10,arcSpacing:500,nodeWidth:400,nodeHeight:300,nodeGapX:50},w={dateParserRegex:"(?<y>-?\\d+)[-/.](?<M>\\d+)[-/.](?<d>\\d+)",dateParserGroupPriority:"y,M,d",dateDisplayFormat:"{y}-{M}-{d}",dateTokenConfiguration:[{name:"y",type:"NUMBER",minLeght:4,displayWhenZero:!0,hideSign:!1,formatting:[]},{name:"M",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]},{name:"d",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]}],applyAdditonalConditionFormatting:!1}});function St(s){return s.type==="NUMBER"}function Ct(s){return s.type==="STRING"}function Dt(s,t,e){switch(s){case"GREATER":return t>e;case"LESS":return t<e;case"EQUAL":return t===e;case"NOTEQUAL":return t!==e;case"GREATEROREQUAL":return t>=e;case"LESSOREQUAL":return t<=e;default:return!1}}function xt(s,t){let e=t.minLeght<0?0:t.minLeght,n=Math.abs(s).toString();for(;n.length<e;)n="0"+n;return!t.hideSign&&s<0&&(n=`-${n}`),n}function wt(s,t){return t.dictionary[s]??String(s)}function Tt(s,t){if(St(t))return xt(s,t);if(Ct(t))return wt(s,t);throw new Error("[Storyflow] Corrupted date token configuration")}function At(s,t,e,n){return n?e.formatting.reduce((a,o)=>(o.conditionsAreExclusive?o.evaluations.some.bind(o.evaluations):o.evaluations.every.bind(o.evaluations))(({condition:i,value:g})=>Dt(i,t,g))?o.format.replace("{value}",a):a,s):s}function C(s,t){let e=t.dateParserGroupPriority.split(","),n=t.dateDisplayFormat.toString();return e.forEach((a,o)=>{let r=a.trim(),c=t.dateTokenConfiguration.find(({name:i})=>i===r);if(!c)throw new Error(`[Storyflow] No date token configuration found for "${r}"`);n=n.replace(`{${r}}`,At(Tt(s[o],c),s[o],c,t.applyAdditonalConditionFormatting))}),n}var U=P(()=>{R()});function E(s,t){let e=Math.max(s.length,t.length);for(let n=0;n<e;n++){let a=s[n]??0,o=t[n]??0;if(a!==o)return a-o}return 0}function Et(s){let t=[1,30,365,365e3,365e6],e=0;for(let n=0;n<s.length;n++){let a=s.length-1-n,o=t[a]??Math.pow(10,a+2);e+=(s[n]??0)*o}return e}function nt(s,t=N){let e=new Map;if(s.length===0)return e;let n=[...s].sort((i,g)=>E(i.date,g.date)),a=n.map(i=>Et(i.date)),o=Math.min(...a),r=[];for(let i of n)r.includes(i.arc)||r.push(i.arc);let c=new Map;for(let i=0;i<n.length;i++){let g=n[i],l=r.indexOf(g.arc),d;if(t.layoutMode==="ordered")d=i*(t.nodeWidth+t.nodeGapX*2);else{d=(a[i]-o)*t.xScale;let f=c.get(g.arc);if(f!==void 0){let p=f+t.nodeWidth+t.nodeGapX;d<p&&(d=p)}c.set(g.arc,d)}let u=l*t.arcSpacing;e.set(g.nodeId,{x:d,y:u})}return e}var j=P(()=>{R()});async function T(s,t,e,n){await s.fileManager.processFrontMatter(t,a=>{a[e]=n})}function Mt(s,t){let e=new Set,n=s.vault.getMarkdownFiles();for(let a of n){let o=s.metadataCache.getFileCache(a);if(!o?.frontmatter)continue;let r=o.frontmatter[t];typeof r=="string"&&r.trim()&&e.add(r.trim())}return[...e].sort()}function at(s,t){new M(s,t,()=>{new O(s,t).open()}).open()}var S,M,O,_=P(()=>{S=require("obsidian");M=class extends S.Modal{file;onComplete;value;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n;let a=t.app.metadataCache.getFileCache(e);this.value=a?.frontmatter?.["story-date"]?.toString()??""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Set date: ${this.file.basename}`}),new S.Setting(t).setName("Story date").setDesc("Format: YYYY-MM-DD (e.g. 2024-06-15) or fantasy format").addText(e=>{e.setPlaceholder("1000-03-15").setValue(this.value).onChange(n=>{this.value=n}),e.inputEl.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),this.save())}),setTimeout(()=>e.inputEl.focus(),50)}),new S.Setting(t).addButton(e=>e.setButtonText("Save").setCta().onClick(()=>this.save()))}async save(){let t=this.value.trim();if(!t){new S.Notice("Date cannot be empty.");return}let e=this.plugin.settings.dateSettings.dateParserRegex;if(!new RegExp(e).test(t)){new S.Notice(`Invalid date format. Needs to match regex:
${e}`);return}await T(this.app,this.file,"story-date",t),new S.Notice(`Set story-date: ${t}`),this.close(),this.onComplete()}onClose(){this.contentEl.empty()}},O=class extends S.SuggestModal{file;onComplete;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n,this.setPlaceholder("Type an arc name or select existing..."),this.setInstructions([{command:"\u2191\u2193",purpose:"navigate"},{command:"\u21B5",purpose:"select or create new"},{command:"esc",purpose:"cancel"}])}getSuggestions(t){let e=Mt(this.app,"story-arc"),n=t.toLowerCase().trim(),a=e.filter(o=>o.toLowerCase().includes(n));return n&&!e.some(o=>o.toLowerCase()===n)&&a.unshift(`+ Create "${t.trim()}"`),a.length>0?a:[`+ Create "${t.trim()||"default"}"`]}renderSuggestion(t,e){e.createEl("span",{text:t})}async onChooseSuggestion(t){let e=t,n=t.match(/^\+ Create "(.+)"$/);n&&(e=n[1]),await T(this.app,this.file,"story-arc",e),new S.Notice(`Set story-arc: ${e}`),this.onComplete()}}});var ot={};Z(ot,{SyncConfirmationModal:()=>K,calculateSyncChanges:()=>It});async function It(s,t,e,n,a){let o=[],r=new Map;for(let l of e){let d=t.nodes.get(l.nodeId);!d||(r.has(l.arc)||r.set(l.arc,[]),r.get(l.arc).push(d.getData().y))}let c=new Map;for(let[l,d]of r.entries()){let u=d.reduce((f,p)=>f+p,0)/d.length;c.set(l,u)}let g=Array.from(t.nodes.entries()).map(([l,d])=>({id:l,data:d.getData()})).filter(l=>l.data.type==="file"&&l.data.file).sort((l,d)=>l.data.x-d.data.x).map(l=>l.id);for(let l of e){let d=t.nodes.get(l.nodeId);if(!d)continue;let u=d.getData(),f=!1,p,h,b=[],D=l.arc,B=1/0;for(let[y,v]of c.entries()){let z=Math.abs(u.y-v);z<B&&(B=z,D=y)}D!==l.arc&&B<n.arcSpacing/2&&(p=D,b.push(`Arc changed from "${l.arc}" to "${p}"`),f=!0);let Q=g.indexOf(l.nodeId),ut=g[Q-1],pt=g[Q+1],x=e.find(y=>y.nodeId===ut),F=e.find(y=>y.nodeId===pt),H=!1;if(x&&E(l.date,x.date)<=0&&(H=!0),F&&E(l.date,F.date)>=0&&(H=!0),H){let y=[...l.date],v=y.length-1;x&&F?(y[v]=Math.floor((x.date[v]+F.date[v])/2),y[v]<=x.date[v]&&(y[v]=x.date[v]+1)):x?y[v]=x.date[v]+1:F&&(y[v]=F.date[v]-1),h=y,b.push(`Sequence moved: expected bounds broken. Suggesting new date: ${C(h,a)}`),f=!0}f&&o.push({scene:l,newArc:p,newDate:h,description:b.join("; ")})}return o}var L,K,st=P(()=>{L=require("obsidian");U();j();_();K=class extends L.Modal{changes;dateSettings;onConfirm;constructor(t,e,n,a){super(t),this.changes=e,this.dateSettings=n,this.onConfirm=a}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:`Sync ${this.changes.length} Changes to Notes`}),t.createEl("p",{text:"The following frontmatter updates will be applied based on your canvas dragging:"});let e=t.createEl("ul",{cls:"storyflow-sync-list"});for(let n of this.changes){let a=e.createEl("li");a.createEl("strong",{text:n.scene.title+": "}),a.createEl("span",{text:n.description})}new L.Setting(t).addButton(n=>n.setButtonText("Cancel").onClick(()=>this.close())).addButton(n=>n.setButtonText("Apply Changes").setCta().onClick(async()=>{this.close();let a=0;for(let o of this.changes){if(o.newArc&&await T(this.app,o.scene.file,"story-arc",o.newArc),o.newDate){let r=C(o.newDate,this.dateSettings);await T(this.app,o.scene.file,"story-date",r)}a++}new L.Notice(`Successfully synced ${a} notes from canvas.`),this.onConfirm()}))}onClose(){this.contentEl.empty()}}});var Ft={};Z(Ft,{default:()=>W});module.exports=vt(Ft);var gt=require("obsidian");var m=require("obsidian");R();function J(s,t,e){if(!!s.frontmatter)return typeof s.frontmatter[t]===e?s.frontmatter[t]:void 0}function bt(s,t,e){try{let n=new RegExp(e).exec(t);if(!n?.groups)return;let a=[];for(let o of s){let r=n.groups[o.trim()];if(r===void 0)return;let c=parseInt(r,10);if(isNaN(c))return;a.push(c)}return a}catch{return}}function $(s,t,e){if(!s.frontmatter)return;let n=s.frontmatter[t];if(n==null)return;let a=e.dateParserGroupPriority.split(",");if(typeof n=="number"){let u=[...Array(Math.max(0,a.length-1))].map(()=>1);return[n,...u]}if(n instanceof Date)return[n.getFullYear(),n.getMonth()+1,n.getDate()];if(typeof n=="object"&&typeof n.toISOString=="function")try{let u=new Date(n.toISOString());return[u.getFullYear(),u.getMonth()+1,u.getDate()]}catch{}let o;typeof n=="string"?o=n.trim():o=String(n).trim();let r=o.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);if(r)return[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10)];let c=o.match(/^(-?\d+)\/(\d{1,2})\/(\d{1,2})/);if(c)return[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)];let i=o.match(/^(-?\d+)\.(\d{1,2})\.(\d{1,2})/);if(i)return[parseInt(i[1],10),parseInt(i[2],10),parseInt(i[3],10)];let g=o.match(/\w+ (\w+) (\d+) (\d{4})/);if(g){let f={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[g[1]];if(f)return[parseInt(g[3],10),f,parseInt(g[2],10)]}let l=o.replace(/[/.]/g,"-"),d=bt(a,l,e.dateParserRegex);if(d)return d;console.warn(`[Storyboard Canvas] Could not parse '${t}' value:`,n,`(type: ${typeof n})`)}function tt(s,t="story-arc"){return J(s,t,"string")??"default"}function et(s,t="story-title"){return J(s,t,"string")??""}U();j();function rt(s=16){return Math.random().toString(36).substring(2,2+s/2)+Math.random().toString(36).substring(2,2+s/2)}var V=class{app;dateSettings;layoutConfig;constructor(t,e=w,n=N){this.app=t,this.layoutConfig=n,this.dateSettings=e}getActiveCanvas(){let t=this.app.workspace.activeLeaf;if(!t)return null;let e=t.view;return e?.getViewType?.()!=="canvas"?null:e.canvas??null}async extractScenes(t){let e=[];for(let[n,a]of t.nodes){let o=a.getData();if(o.type!=="file"||!o.file)continue;let r=this.app.vault.getAbstractFileByPath(o.file);if(!(r instanceof m.TFile))continue;let c=this.app.metadataCache.getFileCache(r);if(!c){console.warn(`[Storyboard] No metadata cache for: ${r.path}`);continue}let i=c.frontmatter?.["story-date"];if(i==null){console.log(`[Storyboard] Skipping ${r.basename}: no story-date in frontmatter`);continue}console.log(`[Storyboard] ${r.basename}: story-date raw =`,i,`(type: ${typeof i}, isDate: ${i instanceof Date})`);let g=$(c,"story-date",this.dateSettings);if(!g){console.warn(`[Storyboard] FAILED to parse story-date for: ${r.basename}, raw value:`,i);continue}let l=$(c,"story-end-date",this.dateSettings),d=tt(c),u=et(c)||r.basename;console.log(`[Storyboard] \u2713 ${r.basename}: date=[${g}], arc="${d}"`),e.push({nodeId:n,file:r,date:g,endDate:l,arc:d,title:u})}return e}async sortStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new m.Notice("No scenes with story-date found on this canvas.");return}let n=nt(e,this.layoutConfig);for(let[a,o]of n){let r=t.nodes.get(a);if(!r)continue;let c=r.getData();r.setData({...c,x:o.x,y:o.y,width:this.layoutConfig.nodeWidth,height:this.layoutConfig.nodeHeight})}t.requestSave(),new m.Notice(`Sorted ${e.length} scenes by date.`)}async connectChronologically(t){let e=await this.extractScenes(t);if(e.length<2){new m.Notice("Need at least 2 scenes with story-date to connect.");return}let n=new Map;for(let r of e){let c=n.get(r.arc)??[];c.push(r),n.set(r.arc,c)}let a=0,o=t.getData();for(let[,r]of n){r.sort((c,i)=>E(c.date,i.date));for(let c=0;c<r.length-1;c++){let i=r[c],g=r[c+1];if(o.edges.some(u=>u.fromNode===i.nodeId&&u.toNode===g.nodeId))continue;let d=C(g.date,this.dateSettings);o.edges.push({id:rt(),fromNode:i.nodeId,toNode:g.nodeId,fromSide:"right",toSide:"left",toEnd:"arrow",label:d}),a++}}a>0&&(t.setData(o),t.requestSave()),new m.Notice(`Connected ${a} scene pairs across ${n.size} arc(s).`)}async connectByLinks(t){let e=this.app.metadataCache.resolvedLinks,n=t.getData(),a=new Map;for(let[c,i]of t.nodes){let g=i.getData();g.type==="file"&&g.file&&a.set(g.file,c)}let o=new Set;for(let c of n.edges)o.add(`${c.fromNode}->${c.toNode}`);let r=0;for(let[c,i]of a){let g=e[c];if(!!g)for(let l in g){let d=a.get(l);if(!d||d===i)continue;let u=`${i}->${d}`;o.has(u)||(n.edges.push({id:rt(),fromNode:i,toNode:d,fromSide:"bottom",toSide:"top",toEnd:"arrow",styleAttributes:{"edge-style":"dotted"}}),o.add(u),r++)}}r>0&&(t.setData(n),t.requestSave()),new m.Notice(`Created ${r} cross-link edges from [[wikilinks]].`)}async buildStoryboard(t){let e=t.nodes.size,n=await this.extractScenes(t),a=e-n.length;if(n.length===0){new m.Notice(`No scenes found. ${e} nodes on canvas but none have story-date frontmatter. Use "Tag scene" command on each note first.`);return}a>0&&new m.Notice(`Found ${n.length} tagged scenes (${a} nodes skipped \u2014 no story-date).`),this.removeMarkerNodes(t),await this.sortStoryboard(t),await this.connectChronologically(t),await this.connectByLinks(t),this.addVisualMarkers(t,n),new m.Notice(`Storyboard built: ${n.length} scenes, sorted + connected + labelled.`)}MARKER_PREFIX="storyboard-marker-";removeMarkerNodes(t){let e=t.getData();e.nodes=e.nodes.filter(n=>!n.id?.startsWith(this.MARKER_PREFIX)),t.setData(e),t.requestSave()}addVisualMarkers(t,e){let n=t.getData(),a=new Map,o=new Map;for(let p of e){let h=t.nodes.get(p.nodeId);if(!h)continue;let b=h.getData();a.has(p.arc)||a.set(p.arc,b.y);let D=C(p.date,this.dateSettings);o.has(D)||o.set(D,b.x)}let r=200,c=60,i=Math.min(...a.values())-c-80,l=Math.min(...o.values())-r-60,d=0;for(let[p,h]of a){let b=["1","2","3","4","5","6"];n.nodes.push({id:`${this.MARKER_PREFIX}arc-${d}`,type:"text",text:`## ${p}`,x:l,y:h+this.layoutConfig.nodeHeight/2-c/2,width:r,height:c,color:b[d%b.length]}),d++}let u=0;for(let[p,h]of o)n.nodes.push({id:`${this.MARKER_PREFIX}date-${u}`,type:"text",text:`**${p}**`,x:h+this.layoutConfig.nodeWidth/2-r/2,y:i,width:r,height:c,color:"0"}),u++;let f=40;for(let p of e){let h=t.nodes.get(p.nodeId);if(!h)continue;let b=h.getData(),D=C(p.date,this.dateSettings);n.nodes.push({id:`${this.MARKER_PREFIX}nodelabel-${p.nodeId}`,type:"text",text:D,x:b.x,y:b.y-f-10,width:this.layoutConfig.nodeWidth,height:f,color:"0"})}t.setData(n),t.requestSave()}async syncStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new m.Notice("No scenes with story-date found.");return}let{calculateSyncChanges:n,SyncConfirmationModal:a}=await Promise.resolve().then(()=>(st(),ot)),o=await n(this.app,t,e,this.layoutConfig,this.dateSettings);if(o.length===0){new m.Notice("No drag-and-drop changes detected.");return}new a(this.app,o,this.dateSettings,()=>{this.buildStoryboard(t)}).open()}async playStoryboard(t,e=1500){let n=await this.extractScenes(t);if(n.length===0){new m.Notice("No scenes with story-date found.");return}n.sort((a,o)=>E(a.date,o.date)),new m.Notice(`Playing ${n.length} scenes...`);for(let a of n){let o=t.nodes.get(a.nodeId);if(!o)continue;let r=o.getData();t.zoomToBbox({minX:r.x-50,minY:r.y-50,maxX:r.x+r.width+50,maxY:r.y+r.height+50}),await new Promise(c=>setTimeout(c,e))}new m.Notice("Playback complete.")}};_();var A=require("obsidian");R();var it={layoutConfig:N,dateSettings:w},X=class extends A.PluginSettingTab{plugin;constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Storyboard Canvas Settings"}),new A.Setting(t).setName("Layout Mode").setDesc("Absolute: position nodes strictly by time elapsed on X-axis. Ordered: distribute nodes evenly in sequence on X-axis.").addDropdown(e=>e.addOption("absolute","Absolute Time Graph").addOption("ordered","Ordered Sequence").setValue(this.plugin.settings.layoutConfig.layoutMode).onChange(async n=>{this.plugin.settings.layoutConfig.layoutMode=n,await this.plugin.saveSettings()})),new A.Setting(t).setName("Date Parser Regex").setDesc("Regex with named capture groups (?<y>, ?<M>, ?<d>) to extract dates from story-date.").addText(e=>e.setPlaceholder(w.dateParserRegex).setValue(this.plugin.settings.dateSettings.dateParserRegex).onChange(async n=>{this.plugin.settings.dateSettings.dateParserRegex=n.trim()||w.dateParserRegex,await this.plugin.saveSettings()})),new A.Setting(t).setName("Date Display Format").setDesc("How dates appear on canvas labels. Use {y}, {M}, {d}.").addText(e=>e.setPlaceholder(w.dateDisplayFormat).setValue(this.plugin.settings.dateSettings.dateDisplayFormat).onChange(async n=>{this.plugin.settings.dateSettings.dateDisplayFormat=n.trim()||w.dateDisplayFormat,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Layout Dimensions"}),new A.Setting(t).setName("X Scale (Absolute Mode)").setDesc("Pixels per date ordinal unit in absolute time graph mode.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.xScale)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.xScale=a,await this.plugin.saveSettings())})),new A.Setting(t).setName("Arc Lane Spacing (Y-Axis)").setDesc("Pixels between arc lanes on the Y-axis.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.arcSpacing)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.arcSpacing=a,await this.plugin.saveSettings())}))}};var I=require("obsidian");U();_();var G="storyboard-inspector-view",Y=class extends I.ItemView{plugin;pollInterval=null;activeNodeId=null;container;contentDiv;constructor(t,e){super(t),this.plugin=e}getViewType(){return G}getDisplayText(){return"Storyboard Inspector"}getIcon(){return"list"}async onOpen(){let{containerEl:t}=this;t.empty(),t.addClass("storyboard-inspector-view"),t.createEl("h3",{text:"Storyboard Inspector"}),this.container=t.createDiv({cls:"inspector-content"}),this.renderEmptyState(),this.pollInterval=window.setInterval(()=>this.pollSelection(),300)}async onClose(){this.pollInterval!==null&&(window.clearInterval(this.pollInterval),this.pollInterval=null)}renderEmptyState(){this.container.empty(),this.container.createEl("p",{text:"Select a single file node on the canvas to inspect it.",cls:"empty-state"}),this.activeNodeId=null}pollSelection(){let t=this.plugin.canvasManager.getActiveCanvas();if(!t){this.activeNodeId!==null&&this.renderEmptyState();return}let e=Array.from(t.selection);if(e.length!==1){this.activeNodeId!==null&&this.renderEmptyState();return}let n=e[0];if(n.getData().type!=="file"||!n.file){this.activeNodeId!==null&&this.renderEmptyState();return}let a=n.getData().id;this.activeNodeId!==a&&(this.activeNodeId=a,this.renderInspector(n))}async renderInspector(t){if(this.container.empty(),!t.file)return;this.container.createEl("h4",{text:t.file.basename});let e=this.app.metadataCache.getFileCache(t.file),n=e?.frontmatter||{},a=n["story-arc"]?.toString()||"",o=n["story-date"]?.toString()||"",r=$(e,"story-date",this.plugin.settings.dateSettings);r&&(o=C(r,this.plugin.settings.dateSettings)),new I.Setting(this.container).setName("Story Arc").setDesc("Which lane or plotline this scene belongs to.").addText(d=>{d.setValue(a).setPlaceholder("e.g. Main Plot").onChange(async u=>{await T(this.app,t.file,"story-arc",u)})}),new I.Setting(this.container).setName("Story Date").setDesc("Format must match plugin settings regex.").addText(d=>{d.setValue(o).setPlaceholder("YYYY-MM-DD").onChange(async u=>{let f=this.plugin.settings.dateSettings.dateParserRegex;new RegExp(f).test(u)&&await T(this.app,t.file,"story-date",u)})}),this.container.createEl("h4",{text:"Timeline Nudge",cls:"timeline-slider-header"}),this.container.createEl("p",{text:"Slide left/right to move the node on the timeline. Release to sync changes to frontmatter.",cls:"setting-item-description"});let i=this.container.createDiv({cls:"timeline-slider-container"}).createEl("input");i.type="range";let g=t.x;i.min=(g-1e3).toString(),i.max=(g+1e3).toString(),i.value=g.toString();let l=this.plugin.canvasManager.getActiveCanvas();i.addEventListener("input",()=>{let d=parseInt(i.value,10);t.setData({...t.getData(),x:d}),l.requestSave()}),i.addEventListener("change",async()=>{let d=t.x;i.min=(d-1e3).toString(),i.max=(d+1e3).toString(),i.value=d.toString(),new I.Notice("Calculating new date from slider position..."),await this.plugin.canvasManager.syncStoryboard(l)})}};var ct=require("obsidian");_();var k=null;function dt(s){console.log("[Storyboard Canvas] installCanvasMenuExtension triggered.. observer flag:",!!k),!k&&(k=new MutationObserver(t=>{for(let e of t)e.type==="childList"&&e.addedNodes.forEach(n=>{n instanceof HTMLElement&&n.hasClass("canvas-node-menu")&&(console.log("[Storyboard Canvas] Menu DOM node injected by Obsidian detected!"),kt(n,s))})}),k.observe(document.body,{childList:!0,subtree:!0}),console.log("[Storyboard Canvas] MutationObserver successfully attached to document.body"))}function lt(){k&&(k.disconnect(),k=null)}function kt(s,t){console.log("[Storyboard Canvas] Attempting to inject Calendar button...");let e=t.canvasManager.getActiveCanvas();if(!e){console.log("[Storyboard Canvas] Aborted injection: No active canvas found.");return}let n=Array.from(e.selection);if(n.length!==1){console.log(`[Storyboard Canvas] Aborted injection: Selection length is ${n.length}`);return}let a=n[0];if(a.getData().type!=="file"||!a.file){console.log(`[Storyboard Canvas] Aborted injection: Node is not a file node. Type=${a.getData().type}`);return}if(s.querySelector(".storyboard-menu-btn")){console.log("[Storyboard Canvas] Aborted injection: Button already exists in DOM.");return}let o=document.createElement("button");o.addClass("clickable-icon"),o.addClass("canvas-node-menu-item"),o.addClass("storyboard-menu-btn"),o.setAttribute("aria-label","Set story-date"),(0,ct.setIcon)(o,"calendar"),o.addEventListener("click",()=>{new M(t,a.file).open()}),s.appendChild(o)}var W=class extends gt.Plugin{canvasManager;settings;async onload(){console.log("[Storyboard Canvas] v0.4.3 - Plugin loading started..."),await this.loadSettings(),this.canvasManager=new V(this.app,this.settings.dateSettings,this.settings.layoutConfig),this.addSettingTab(new X(this.app,this)),console.log("[Storyboard Canvas] Settings Tab registered."),console.log("[Storyboard Canvas] Registering Inspector View..."),this.registerView(G,t=>new Y(t,this)),console.log("[Storyboard Canvas] Adding Ribbon Icon..."),this.addRibbonIcon("list","Open Storyboard Inspector",()=>{this.activateInspectorView()}),console.log("[Storyboard Canvas] Installing Canvas Menu Extension..."),dt(this),console.log("[Storyboard Canvas] UI Enhancements successfully loaded."),this.addCommand({id:"storyboard-set-date",name:"Set story date on current note",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||new M(this,e).open(),!0)}}),this.addCommand({id:"storyboard-set-arc",name:"Set story arc on current note",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||new O(this,e).open(),!0)}}),this.addCommand({id:"storyboard-tag-scene",name:"Tag scene (set date + arc)",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||at(this,e),!0)}}),this.addCommand({id:"storyboard-build",name:"Build storyboard (sort + connect + cross-link)",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.buildStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sort",name:"Sort storyboard by date",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.sortStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-connect",name:"Connect scenes chronologically",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectChronologically(e),!0):!1}}),this.addCommand({id:"storyboard-crosslink",name:"Add cross-link edges from [[wikilinks]]",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectByLinks(e),!0):!1}}),this.addCommand({id:"storyboard-play",name:"Play storyboard",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.playStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sync",name:"Sync canvas to notes",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.syncStoryboard(e),!0):!1}})}async loadSettings(){this.settings=Object.assign({},it,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.canvasManager&&(this.canvasManager.dateSettings=this.settings.dateSettings,this.canvasManager.layoutConfig=this.settings.layoutConfig)}async activateInspectorView(){let{workspace:t}=this.app,e=null,n=t.getLeavesOfType(G);n.length>0?e=n[0]:(e=t.getRightLeaf(!1),e&&await e.setViewState({type:G,active:!0})),e&&t.revealLeaf(e)}onunload(){lt()}};
