var ot=Object.defineProperty;var Mt=Object.getOwnPropertyDescriptor;var Ft=Object.getOwnPropertyNames;var It=Object.prototype.hasOwnProperty;var q=(r,t)=>()=>(r&&(t=r(r=0)),t);var rt=(r,t)=>{for(var e in t)ot(r,e,{get:t[e],enumerable:!0})},kt=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Ft(t))!It.call(r,a)&&a!==e&&ot(r,a,{get:()=>t[a],enumerable:!(n=Mt(t,a))||n.enumerable});return r};var Lt=r=>kt(ot({},"__esModule",{value:!0}),r);var V,P,K=q(()=>{V={layoutMode:"absolute",xScale:10,arcSpacing:500,nodeWidth:400,nodeHeight:300,nodeGapX:50,playbackSpeed:1500},P={dateParserRegex:"(?<y>-?\\d+)[-/.](?<M>\\d+)[-/.](?<d>\\d+)",dateParserGroupPriority:"y,M,d",dateDisplayFormat:"{y}-{M}-{d}",dateTokenConfiguration:[{name:"y",type:"NUMBER",minLeght:4,displayWhenZero:!0,hideSign:!1,formatting:[]},{name:"M",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]},{name:"d",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]}],applyAdditonalConditionFormatting:!1}});function Nt(r){return r.type==="NUMBER"}function $t(r){return r.type==="STRING"}function Ot(r,t,e){switch(r){case"GREATER":return t>e;case"LESS":return t<e;case"EQUAL":return t===e;case"NOTEQUAL":return t!==e;case"GREATEROREQUAL":return t>=e;case"LESSOREQUAL":return t<=e;default:return!1}}function Rt(r,t){let e=t.minLeght<0?0:t.minLeght,n=Math.abs(r).toString();for(;n.length<e;)n="0"+n;return!t.hideSign&&r<0&&(n=`-${n}`),n}function Vt(r,t){return t.dictionary[r]??String(r)}function _t(r,t){if(Nt(t))return Rt(r,t);if($t(t))return Vt(r,t);throw new Error("[Storyflow] Corrupted date token configuration")}function Bt(r,t,e,n){return n?e.formatting.reduce((a,s)=>(s.conditionsAreExclusive?s.evaluations.some.bind(s.evaluations):s.evaluations.every.bind(s.evaluations))(({condition:c,value:d})=>Ot(c,t,d))?s.format.replace("{value}",a):a,r):r}function I(r,t){let e=t.dateParserGroupPriority.split(","),n=t.dateDisplayFormat.toString();return e.forEach((a,s)=>{let o=a.trim(),i=t.dateTokenConfiguration.find(({name:c})=>c===o);if(!i)throw new Error(`[Storyflow] No date token configuration found for "${o}"`);n=n.replace(`{${o}}`,Bt(_t(r[s],i),r[s],i,t.applyAdditonalConditionFormatting))}),n}function mt(r,t){if(r.length<3||t.length<3)return"Later";let e=r[0]||0,n=r[1]||0,a=r[2]||0,s=t[0]||0,o=t[1]||0,i=t[2]||0,c=s-e,d=o-n,l=i-a;if(l<0&&(d-=1,l+=30),d<0&&(c-=1,d+=12),c===0&&d===0&&l===0)return"Same time";let p=[];return c>0&&p.push(`${c} year${c>1?"s":""}`),d>0&&p.push(`${d} month${d>1?"s":""}`),l>0&&p.push(`${l} day${l>1?"s":""}`),p.join(", ")+" later"}var J=q(()=>{K()});function O(r,t){let e=Math.max(r.length,t.length);for(let n=0;n<e;n++){let a=r[n]??0,s=t[n]??0;if(a!==s)return a-s}return 0}function Wt(r){let t=[1,30,365,365e3,365e6],e=0;for(let n=0;n<r.length;n++){let a=r.length-1-n,s=t[a]??Math.pow(10,a+2);e+=(r[n]??0)*s}return e}function vt(r,t=V){let e=new Map;if(r.length===0)return e;let n=[...r].sort((c,d)=>O(c.date,d.date)),a=n.map(c=>Wt(c.date)),s=Math.min(...a),o=[];for(let c of n)o.includes(c.arc)||o.push(c.arc);let i=new Map;for(let c=0;c<n.length;c++){let d=n[c],l=o.indexOf(d.arc),p;if(t.layoutMode==="ordered")p=c*(t.nodeWidth+t.nodeGapX*2);else{p=(a[c]-s)*t.xScale;let h=i.get(d.arc);if(h!==void 0){let m=h+t.nodeWidth+t.nodeGapX;p<m&&(p=m)}i.set(d.arc,p)}let f=l*t.arcSpacing;e.set(d.nodeId,{x:p,y:f})}return e}var it=q(()=>{K()});var bt={};rt(bt,{SetArcModal:()=>B,SetDateModal:()=>_,SetDependenciesModal:()=>W,SetTensionModal:()=>U,collectFrontmatterValues:()=>tt,setFrontmatterKey:()=>F,tagScene:()=>lt});async function F(r,t,e,n){await r.fileManager.processFrontMatter(t,a=>{a[e]=n})}function tt(r,t){let e=new Set,n=r.vault.getMarkdownFiles();for(let a of n){let s=r.metadataCache.getFileCache(a);if(!s?.frontmatter)continue;let o=s.frontmatter[t];typeof o=="string"&&o.trim()&&e.add(o.trim())}return[...e].sort()}function lt(r,t){new _(r,t,()=>{new B(r,t,()=>{new U(r,t,()=>{new W(r,t).open()}).open()}).open()}).open()}var w,_,B,W,ct,U,j=q(()=>{w=require("obsidian");_=class extends w.Modal{file;onComplete;value;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n;let a=t.app.metadataCache.getFileCache(e);this.value=a?.frontmatter?.["story-date"]?.toString()??""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Set date: ${this.file.basename}`}),new w.Setting(t).setName("Story date").setDesc("Format: YYYY-MM-DD (e.g. 2024-06-15) or fantasy format").addText(e=>{e.setPlaceholder("1000-03-15").setValue(this.value).onChange(n=>{this.value=n}),e.inputEl.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),this.save())}),setTimeout(()=>e.inputEl.focus(),50)}),new w.Setting(t).addButton(e=>e.setButtonText("Save").setCta().onClick(()=>this.save()))}async save(){let t=this.value.trim();if(!t){new w.Notice("Date cannot be empty.");return}let e=this.plugin.settings.dateSettings.dateParserRegex;if(!new RegExp(e).test(t)){new w.Notice(`Invalid date format. Needs to match regex:
${e}`);return}await F(this.app,this.file,"story-date",t),new w.Notice(`Set story-date: ${t}`);let a=this.plugin.canvasManager.getActiveCanvas();a&&await this.plugin.canvasManager.buildStoryboard(a),this.close(),this.onComplete()}onClose(){this.contentEl.empty()}},B=class extends w.SuggestModal{file;onComplete;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n,this.setPlaceholder("Type an arc name or select existing..."),this.setInstructions([{command:"\u2191\u2193",purpose:"navigate"},{command:"\u21B5",purpose:"select or create new"},{command:"esc",purpose:"cancel"}])}getSuggestions(t){let e=tt(this.app,"story-arc"),n=t.toLowerCase().trim(),a=e.filter(s=>s.toLowerCase().includes(n));return n&&!e.some(s=>s.toLowerCase()===n)&&a.unshift(`+ Create "${t.trim()}"`),a.length>0?a:[`+ Create "${t.trim()||"default"}"`]}renderSuggestion(t,e){e.createEl("span",{text:t})}async onChooseSuggestion(t){let e=t,n=t.match(/^\+ Create "(.+)"$/);n&&(e=n[1]),await F(this.app,this.file,"story-arc",e),new w.Notice(`Set story-arc: ${e}`);let a=this.plugin.canvasManager.getActiveCanvas();a&&await this.plugin.canvasManager.buildStoryboard(a),this.onComplete()}},W=class r extends w.SuggestModal{file;onComplete;plugin;allFiles;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n,this.allFiles=this.app.vault.getMarkdownFiles().filter(a=>a.path!==e.path),this.setPlaceholder("Select a file to depend on (or ESC to skip)...")}getSuggestions(t){let e=t.toLowerCase();return this.allFiles.filter(n=>n.basename.toLowerCase().includes(e))}renderSuggestion(t,e){e.createEl("div",{text:t.basename}),e.createEl("small",{text:t.path,cls:"storyflow-subtext"})}async onChooseSuggestion(t){new ct(this.plugin,this.file,t.basename,()=>{new r(this.plugin,this.file,this.onComplete).open()}).open()}onClose(){super.onClose(),setTimeout(()=>{document.querySelector(".modal-container")||this.onComplete()},100)}},ct=class extends w.Modal{plugin;file;targetBasename;onComplete;constructor(t,e,n,a){super(t.app),this.plugin=t,this.file=e,this.targetBasename=n,this.onComplete=a}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Dependency: ${this.targetBasename}`}),t.createEl("p",{text:`Does "${this.targetBasename}" happen BEFORE or AFTER "${this.file.basename}"?`});let e=t.createDiv({cls:"storyflow-flex-row"});e.createEl("button",{text:"Happens BEFORE"}).addEventListener("click",async s=>{s.preventDefault(),await this.saveDependency("before"),this.close()}),e.createEl("button",{text:"Happens AFTER"}).addEventListener("click",async s=>{s.preventDefault(),await this.saveDependency("after"),this.close()})}async saveDependency(t){let e=`${this.targetBasename}:${t}`;await this.app.fileManager.processFrontMatter(this.file,i=>{let c=i["story-deps"]||[];Array.isArray(c)||(c=[c]),c.includes(e)||(c=[...c,e]),i["story-deps"]=c});let n=t==="before"?"after":"before",a=`${this.file.basename}:${n}`,s=this.app.vault.getMarkdownFiles().find(i=>i.basename===this.targetBasename);s?(await this.app.fileManager.processFrontMatter(s,i=>{let c=i["story-deps"]||[];Array.isArray(c)||(c=[c]),c.includes(a)||(c=[...c,a]),i["story-deps"]=c}),new w.Notice(`Linked: ${this.file.basename} & ${this.targetBasename}`)):new w.Notice(`Added one-way dependency: ${e}`);let o=this.plugin.canvasManager.getActiveCanvas();o&&await this.plugin.canvasManager.buildStoryboard(o)}onClose(){this.contentEl.empty(),this.onComplete()}},U=class extends w.Modal{file;onComplete;value=5;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n;let s=t.app.metadataCache.getFileCache(e)?.frontmatter?.tension;typeof s=="number"&&s>=1&&s<=10&&(this.value=s)}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Set tension: ${this.file.basename}`});let e=t.createEl("div",{text:`Level: ${this.value}`});e.style.textAlign="center",e.style.fontSize="1.2em",e.style.fontWeight="bold",e.style.marginBottom="12px",new w.Setting(t).setName("Pacing / Dramatic Tension").setDesc("1 (Calm) to 10 (High Action)").addSlider(n=>{n.setLimits(1,10,1).setValue(this.value).setDynamicTooltip().onChange(a=>{this.value=a,e.setText(`Level: ${a}`)})}),new w.Setting(t).addButton(n=>n.setButtonText("Save").setCta().onClick(()=>this.save()))}async save(){await F(this.app,this.file,"tension",this.value),new w.Notice(`Set tension: ${this.value}`);let t=this.plugin.canvasManager.getActiveCanvas();t&&await this.plugin.canvasManager.sortStoryboard(t),this.close(),this.onComplete()}onClose(){this.contentEl.empty()}}});var St={};rt(St,{SyncConfirmationModal:()=>dt,calculateSyncChanges:()=>Ut});async function Ut(r,t,e,n,a){let s=[],o=new Map;for(let l of e){let p=t.nodes.get(l.nodeId);p&&(o.has(l.arc)||o.set(l.arc,[]),o.get(l.arc).push(p.getData().y))}let i=new Map;for(let[l,p]of o.entries()){let f=p.reduce((h,m)=>h+m,0)/p.length;i.set(l,f)}let d=Array.from(t.nodes.entries()).map(([l,p])=>({id:l,data:p.getData()})).filter(l=>l.data.type==="file"&&l.data.file).sort((l,p)=>l.data.x-p.data.x).map(l=>l.id);for(let l of e){let p=t.nodes.get(l.nodeId);if(!p)continue;let f=p.getData(),h=!1,m,v,b=[],S=l.arc,A=1/0;for(let[x,C]of i.entries()){let H=Math.abs(f.y-C);H<A&&(A=H,S=x)}S!==l.arc&&A<n.arcSpacing/2&&(m=S,b.push(`Arc changed from "${l.arc}" to "${m}"`),h=!0);let z=d.indexOf(l.nodeId),Z=d[z-1],X=d[z+1],k=e.find(x=>x.nodeId===Z),E=e.find(x=>x.nodeId===X),$=!1;if(k&&O(l.date,k.date)<=0&&($=!0),E&&O(l.date,E.date)>=0&&($=!0),$){let x=[...l.date],C=x.length-1;k&&E?(x[C]=Math.floor((k.date[C]+E.date[C])/2),x[C]<=k.date[C]&&(x[C]=k.date[C]+1)):k?x[C]=k.date[C]+1:E&&(x[C]=E.date[C]-1),v=x,b.push(`Sequence moved: expected bounds broken. Suggesting new date: ${I(v,a)}`),h=!0}h&&s.push({scene:l,newArc:m,newDate:v,description:b.join("; ")})}return s}var Y,dt,Ct=q(()=>{Y=require("obsidian");J();it();j();dt=class extends Y.Modal{changes;dateSettings;onConfirm;constructor(t,e,n,a){super(t),this.changes=e,this.dateSettings=n,this.onConfirm=a}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:`Sync ${this.changes.length} Changes to Notes`}),t.createEl("p",{text:"The following frontmatter updates will be applied based on your canvas dragging:"});let e=t.createEl("ul",{cls:"storyflow-sync-list"});for(let n of this.changes){let a=e.createEl("li");a.createEl("strong",{text:n.scene.title+": "}),a.createEl("span",{text:n.description})}new Y.Setting(t).addButton(n=>n.setButtonText("Cancel").onClick(()=>this.close())).addButton(n=>n.setButtonText("Apply Changes").setCta().onClick(async()=>{this.close();let a=0;for(let s of this.changes){if(s.newArc&&await F(this.app,s.scene.file,"story-arc",s.newArc),s.newDate){let o=I(s.newDate,this.dateSettings);await F(this.app,s.scene.file,"story-date",o)}a++}new Y.Notice(`Successfully synced ${a} notes from canvas.`),this.onConfirm()}))}onClose(){this.contentEl.empty()}}});var Gt={};rt(Gt,{default:()=>at});module.exports=Lt(Gt);var Tt=require("obsidian");var T=require("obsidian");K();function ft(r,t,e){if(r.frontmatter)return typeof r.frontmatter[t]===e?r.frontmatter[t]:void 0}function Pt(r,t,e){try{let n=new RegExp(e).exec(t);if(!n?.groups)return;let a=[];for(let s of r){let o=n.groups[s.trim()];if(o===void 0)return;let i=parseInt(o,10);if(isNaN(i))return;a.push(i)}return a}catch{return}}function Q(r,t,e){if(!r.frontmatter)return;let n=r.frontmatter[t];if(n==null)return;let a=e.dateParserGroupPriority.split(",");if(typeof n=="number"){let f=[...Array(Math.max(0,a.length-1))].map(()=>1);return[n,...f]}if(n instanceof Date)return[n.getFullYear(),n.getMonth()+1,n.getDate()];if(typeof n=="object"&&typeof n.toISOString=="function")try{let f=new Date(n.toISOString());return[f.getFullYear(),f.getMonth()+1,f.getDate()]}catch{}let s;typeof n=="string"?s=n.trim():s=String(n).trim();let o=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);if(o)return[parseInt(o[1],10),parseInt(o[2],10),parseInt(o[3],10)];let i=s.match(/^(-?\d+)\/(\d{1,2})\/(\d{1,2})/);if(i)return[parseInt(i[1],10),parseInt(i[2],10),parseInt(i[3],10)];let c=s.match(/^(-?\d+)\.(\d{1,2})\.(\d{1,2})/);if(c)return[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)];let d=s.match(/\w+ (\w+) (\d+) (\d{4})/);if(d){let h={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[d[1]];if(h)return[parseInt(d[3],10),h,parseInt(d[2],10)]}let l=s.replace(/[/.]/g,"-"),p=Pt(a,l,e.dateParserRegex);if(p)return p;console.warn(`[Storyboard Canvas] Could not parse '${t}' value:`,n,`(type: ${typeof n})`)}function ht(r,t="story-arc"){return ft(r,t,"string")??"default"}function yt(r,t="story-title"){return ft(r,t,"string")??""}J();it();function wt(r=16){return Math.random().toString(36).substring(2,2+r/2)+Math.random().toString(36).substring(2,2+r/2)}var et=class{app;dateSettings;layoutConfig;constructor(t,e=P,n=V){this.app=t,this.layoutConfig=n,this.dateSettings=e}getActiveCanvas(){let t=this.app.workspace.getLeavesOfType("canvas");return t.length===0?null:t[0].view.canvas??null}async extractScenes(t){let e=[];for(let[n,a]of t.nodes){let s=a.getData();if(s.type!=="file"||!s.file)continue;let o=this.app.vault.getAbstractFileByPath(s.file);if(!(o instanceof T.TFile))continue;let i=this.app.metadataCache.getFileCache(o);if(!i){console.warn(`[Storyboard] No metadata cache for: ${o.path}`);continue}let c=i.frontmatter?.["story-date"];if(c==null){console.log(`[Storyboard] Skipping ${o.basename}: no story-date in frontmatter`);continue}console.log(`[Storyboard] ${o.basename}: story-date raw =`,c,`(type: ${typeof c}, isDate: ${c instanceof Date})`);let d=Q(i,"story-date",this.dateSettings);if(!d){console.warn(`[Storyboard] FAILED to parse story-date for: ${o.basename}, raw value:`,c);continue}let l=Q(i,"story-end-date",this.dateSettings),p=ht(i),f=yt(i)||o.basename,h=i.frontmatter?.["story-deps"],m=[];if(Array.isArray(h)){for(let S of h)if(typeof S=="string"){let A=S.split(":");A.length===2&&(A[1]==="before"||A[1]==="after")&&m.push({basename:A[0],type:A[1]})}}let v=i.frontmatter?.tension,b;typeof v=="number"&&v>=1&&v<=10&&(b=v),console.log(`[Storyboard] \u2713 ${o.basename}: date=[${d}], arc="${p}", tension=${b}`),e.push({nodeId:n,file:o,date:d,endDate:l,arc:p,title:f,tension:b,deps:m})}return e}async sortStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new T.Notice("No scenes with story-date found on this canvas.");return}let n=t.getData();this.applySortToData(n,e),t.setData(n),t.requestSave(),this.applyTensionClasses(t,e),new T.Notice(`Sorted ${e.length} scenes by date.`)}applySortToData(t,e){let n=vt(e,this.layoutConfig);for(let[a,s]of n){let o=t.nodes.find(i=>i.id===a);o&&(o.x=s.x,o.y=s.y,o.width=this.layoutConfig.nodeWidth,o.height=this.layoutConfig.nodeHeight)}}applyTensionClasses(t,e){setTimeout(()=>{for(let n of e){let a=t.nodes.get(n.nodeId);if(a?.nodeEl){for(let s=1;s<=10;s++)a.nodeEl.classList.remove(`storyboard-tension-${s}`);n.tension&&Object.keys(a.nodeEl.classList).length,n.tension&&a.nodeEl.classList.add(`storyboard-tension-${Math.floor(n.tension)}`)}}},150)}async connectChronologically(t){let e=await this.extractScenes(t);if(e.length<2){new T.Notice("Need at least 2 scenes with story-date to connect.");return}let n=t.getData(),a=this.applyChronologicalEdgesToData(n,e);a>0&&(t.setData(n),t.requestSave()),new T.Notice(`Connected ${a} chronological scene pairs.`)}applyChronologicalEdgesToData(t,e){let n=new Map;for(let s of e){let o=n.get(s.arc)??[];o.push(s),n.set(s.arc,o)}let a=0;t.edges=t.edges.filter(s=>!s.id?.startsWith(`${this.MARKER_PREFIX}edge-chrono`));for(let[,s]of n){s.sort((o,i)=>O(o.date,i.date));for(let o=0;o<s.length-1;o++){let i=s[o],c=s[o+1];if(t.edges.some(p=>p.fromNode===i.nodeId&&p.toNode===c.nodeId&&!p.id?.startsWith(this.MARKER_PREFIX)))continue;let l=mt(i.date,c.date);t.edges.push({id:`${this.MARKER_PREFIX}edge-chrono-${wt()}`,fromNode:i.nodeId,toNode:c.nodeId,fromSide:"right",toSide:"left",toEnd:"arrow",label:l}),a++}}return a}async connectByLinks(t){let e=t.getData(),n=this.applyCrossLinksToData(e,this.app.metadataCache.resolvedLinks);n>0&&(t.setData(e),t.requestSave()),new T.Notice(`Created ${n} cross-link edges from [[wikilinks]].`)}applyCrossLinksToData(t,e){let n=new Map;for(let o of t.nodes)o.type==="file"&&o.file&&n.set(o.file,o.id);t.edges=t.edges.filter(o=>!o.id?.startsWith(`${this.MARKER_PREFIX}edge-link`));let a=new Set;for(let o of t.edges)a.add(`${o.fromNode}->${o.toNode}`);let s=0;for(let[o,i]of n){let c=e[o];if(c)for(let d in c){let l=n.get(d);if(!l||l===i)continue;let p=`${i}->${l}`;a.has(p)||(t.edges.push({id:`${this.MARKER_PREFIX}edge-link-${wt()}`,fromNode:i,toNode:l,fromSide:"bottom",toSide:"top",toEnd:"arrow",styleAttributes:{"edge-style":"dotted"}}),a.add(p),s++)}}return s}async buildStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new T.Notice('No scenes with story-date found on this canvas. Use "Tag scene" command on each note first.');return}for(let[a,s]of t.nodes.entries())s.getData().type!=="file"&&t.removeNode(s);for(let[a,s]of t.edges.entries())t.removeEdge(s);let n=t.getData();this.applySortToData(n,e),this.applyChronologicalEdgesToData(n,e),this.applyCrossLinksToData(n,this.app.metadataCache.resolvedLinks),this.addVisualMarkersToData(n,e),t.setData(n),t.requestSave(),this.applyTensionClasses(t,e),new T.Notice(`Storyboard built: ${e.length} scenes, sorted + connected + labelled.`)}MARKER_PREFIX="storyboard-marker-";removeMarkerNodes(t){let e=t.getData();e.nodes=e.nodes.filter(n=>!n.id?.startsWith(this.MARKER_PREFIX)),t.setData(e),t.requestSave()}addVisualMarkersToData(t,e){let n=new Map,a=new Map;for(let v of e){let b=t.nodes.find(A=>A.id===v.nodeId);if(!b)continue;n.has(v.arc)||n.set(v.arc,b.y);let S=I(v.date,this.dateSettings);a.has(S)||a.set(S,b.x)}let s=200,o=60,i=Array.from(n.values()),c=i.length>0?Math.min(...i)-o-80:0,d=Array.from(a.values()),p=(d.length>0?Math.min(...d):0)-s-60,f=0;for(let[v,b]of n){let S=["1","2","3","4","5","6"];t.nodes.push({id:`${this.MARKER_PREFIX}arc-${f}`,type:"text",text:`## ${v}`,x:p,y:b+this.layoutConfig.nodeHeight/2-o/2,width:s,height:o,color:S[f%S.length]}),f++}let h=0;for(let[v,b]of a)t.nodes.push({id:`${this.MARKER_PREFIX}date-${h}`,type:"text",text:`**${v}**`,x:b+this.layoutConfig.nodeWidth/2-s/2,y:c,width:s,height:o,color:"0"}),h++;let m=40;for(let v of e){let b=t.nodes.find(A=>A.id===v.nodeId);if(!b)continue;let S=I(v.date,this.dateSettings);t.nodes.push({id:`${this.MARKER_PREFIX}nodelabel-${v.nodeId}`,type:"text",text:S,x:b.x,y:b.y-m-10,width:this.layoutConfig.nodeWidth,height:m,color:"0"})}}async syncStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new T.Notice("No scenes with story-date found.");return}let{calculateSyncChanges:n}=await Promise.resolve().then(()=>(Ct(),St)),{setFrontmatterKey:a}=await Promise.resolve().then(()=>(j(),bt)),s=await n(this.app,t,e,this.layoutConfig,this.dateSettings);if(s.length===0){new T.Notice("No drag-and-drop changes detected. Refreshing canvas layout from notes."),this.buildStoryboard(t);return}let o=0;for(let i of s){if(i.newArc&&await a(this.app,i.scene.file,"story-arc",i.newArc),i.newDate){let c=I(i.newDate,this.dateSettings);await a(this.app,i.scene.file,"story-date",c)}o++}new T.Notice(`Successfully auto-synced ${o} nodes to their frontmatter.`),this.buildStoryboard(t)}async playStoryboard(t,e){let n=e??this.layoutConfig.playbackSpeed??1500,a=await this.extractScenes(t);if(a.length===0){new T.Notice("No scenes with story-date found.");return}a.sort((s,o)=>O(s.date,o.date)),new T.Notice(`Playing ${a.length} scenes...`);for(let s of a){let o=t.nodes.get(s.nodeId);if(!o)continue;let i=o.getData();t.zoomToBbox({minX:i.x-50,minY:i.y-50,maxX:i.x+i.width+50,maxY:i.y+i.height+50}),await new Promise(c=>setTimeout(c,n))}new T.Notice("Playback complete.")}};j();var N=require("obsidian");K();var Dt={layoutConfig:V,dateSettings:P},nt=class extends N.PluginSettingTab{plugin;constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Storyboard Canvas Settings"}),new N.Setting(t).setName("Date Parser Regex").setDesc("Regex with named capture groups (?<y>, ?<M>, ?<d>) to extract dates from story-date.").addText(e=>e.setPlaceholder(P.dateParserRegex).setValue(this.plugin.settings.dateSettings.dateParserRegex).onChange(async n=>{this.plugin.settings.dateSettings.dateParserRegex=n.trim()||P.dateParserRegex,await this.plugin.saveSettings()})),new N.Setting(t).setName("Date Display Format").setDesc("How dates appear on canvas labels. Use {y}, {M}, {d}.").addText(e=>e.setPlaceholder(P.dateDisplayFormat).setValue(this.plugin.settings.dateSettings.dateDisplayFormat).onChange(async n=>{this.plugin.settings.dateSettings.dateDisplayFormat=n.trim()||P.dateDisplayFormat,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Layout Dimensions"}),new N.Setting(t).setName("X Scale (Absolute Mode)").setDesc("Pixels per date ordinal unit in absolute time graph mode.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.xScale)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.xScale=a,await this.plugin.saveSettings())})),new N.Setting(t).setName("Arc Lane Spacing (Y-Axis)").setDesc("Pixels between arc lanes on the Y-axis.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.arcSpacing)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.arcSpacing=a,await this.plugin.saveSettings())})),new N.Setting(t).setName("Playback Speed (ms)").setDesc("Milliseconds between scenes during animated playback.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.playbackSpeed)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.playbackSpeed=a,await this.plugin.saveSettings())}))}};var M=require("obsidian");J();j();var R="storyboard-inspector-view",G=class extends M.ItemView{plugin;pollInterval=null;activeNodeId=null;showConstraintWindow=!1;container;contentDiv;constructor(t,e){super(t),this.plugin=e}getViewType(){return R}getDisplayText(){return"Storyboard Inspector"}getIcon(){return"list"}async onOpen(){let{containerEl:t}=this;t.empty(),t.addClass("storyboard-inspector-view");let e=t.createEl("h3",{text:"Storyboard Inspector",cls:"storyboard-inspector-title"});this.container=t.createDiv({cls:"inspector-content"}),this.renderEmptyState(),this.pollInterval=window.setInterval(()=>this.pollSelection(),300),this.registerEvent(this.app.metadataCache.on("changed",n=>{if(!this.activeNodeId||this.container?.contains(document.activeElement))return;let a=this.plugin.canvasManager.getActiveCanvas();if(!a)return;let s=a.nodes.get(this.activeNodeId);s&&s.getData().type==="file"&&s.file?.path===n.path&&setTimeout(()=>this.renderInspector(s),50)}))}async onClose(){this.pollInterval!==null&&(window.clearInterval(this.pollInterval),this.pollInterval=null),this.container.empty()}renderEmptyState(){this.container.empty();let t=this.container.createDiv({cls:"storyboard-inspector-inner"}),e=t.createDiv({cls:"storyflow-inspector-card"});e.createEl("h4",{text:"Canvas View Mode",cls:"storyboard-inspector-card-title"}),this.plugin?.settings?.layoutConfig&&new M.Setting(e).setName("Layout Sequence").setDesc(this.plugin.settings.layoutConfig.layoutMode==="absolute"?"Strict timeline spacing":"Evenly distributed layout").addDropdown(n=>n.addOption("absolute","Absolute Time").addOption("ordered","Ordered Sequence").setValue(this.plugin.settings.layoutConfig.layoutMode).onChange(async a=>{this.plugin.settings.layoutConfig.layoutMode=a,await this.plugin.saveSettings();let s=this.plugin.canvasManager.getActiveCanvas();s&&await this.plugin.canvasManager.buildStoryboard(s),this.onOpen()})),t.createDiv({text:"Select a single file node on the canvas to inspect it.",cls:"storyflow-empty-state-card"}),this.activeNodeId=null,this.showConstraintWindow=!1,this.clearConstraintOverlays()}pollSelection(){if(this.container?.contains(document.activeElement))return;let t=this.plugin.canvasManager.getActiveCanvas();if(!t){this.activeNodeId!==null&&this.renderEmptyState();return}let e=Array.from(t.selection);if(e.length!==1){this.activeNodeId!==null&&this.renderEmptyState();return}let n=e[0];if(n.getData().type!=="file"||!n.file){this.activeNodeId!==null&&this.renderEmptyState();return}let a=n.getData().id;this.activeNodeId!==a&&(this.activeNodeId=a,this.renderInspector(n))}async renderInspector(t){if(this.container.empty(),this.clearConstraintOverlays(),!t.file)return;let e=this.container.createDiv({cls:"storyboard-inspector-inner"}),n=e.createDiv({cls:"storyboard-inspector-header"});n.createEl("h3",{text:t.file.basename}),n.createEl("div",{text:"Storyboard Node",cls:"storyflow-subtext"});let a=e.createDiv({cls:"storyboard-inspector-card"});a.createEl("h4",{text:"Canvas View Mode",cls:"storyboard-inspector-card-title"}),new M.Setting(a).setName("Layout Sequence").setDesc(this.plugin.settings.layoutConfig.layoutMode==="absolute"?"Strict timeline spacing":"Evenly distributed layout").addDropdown(u=>u.addOption("absolute","Absolute Time").addOption("ordered","Ordered Sequence").setValue(this.plugin.settings.layoutConfig.layoutMode).onChange(async y=>{this.plugin.settings.layoutConfig.layoutMode=y,await this.plugin.saveSettings();let g=this.plugin.canvasManager.getActiveCanvas();g&&await this.plugin.canvasManager.buildStoryboard(g),this.activeNodeId=null,this.onOpen()}));let s=this.app.metadataCache.getFileCache(t.file),o=s?.frontmatter||{},i=o["story-arc"]?.toString()||"",c=o["story-date"]?.toString()||"",d=5;typeof o.tension=="number"&&o.tension>=1&&o.tension<=10&&(d=o.tension);let l=Q(s,"story-date",this.plugin.settings.dateSettings);l&&(c=I(l,this.plugin.settings.dateSettings));let p=o["story-deps"],f=[];if(Array.isArray(p)){for(let u of p)if(typeof u=="string"){let y=u.split(":");y.length===2&&(y[1]==="before"||y[1]==="after")&&f.push({basename:y[0],type:y[1]})}}let h=null,m=null,v="-\u221E",b="+\u221E",S=this.plugin.canvasManager.getActiveCanvas();if(S)try{let u=await this.plugin.canvasManager.extractScenes(S);if(i){let y=u.filter(D=>D.arc===i).sort((D,L)=>this.compareAbstractDates(D.date,L.date)),g=y.findIndex(D=>D.nodeId===t.getData().id);if(g!==-1){let D=g>0?y[g-1]:null,L=g<y.length-1?y[g+1]:null;D&&(h=D.date,v=`${D.title} (Arc)`),L&&(m=L.date,b=`${L.title} (Arc)`)}}for(let y of f){let g=u.find(D=>D.file.basename===y.basename);g&&(y.type==="after"?(!h||this.compareAbstractDates(g.date,h)>0)&&(h=g.date,v=`${g.title} (Dep)`):y.type==="before"&&(!m||this.compareAbstractDates(g.date,m)<0)&&(m=g.date,b=`${g.title} (Dep)`))}}catch{}let A=h?I(h,this.plugin.settings.dateSettings):"-\u221E",z=m?I(m,this.plugin.settings.dateSettings):"+\u221E",Z="Allowed Window: Any date";(h||m)&&(Z=`Allowed: ${A} \u2794 ${z}
Bounded by: [${v}] and [${b}]`);let X=e.createDiv({cls:"storyflow-inspector-card"});X.createEl("h4",{text:"Timeline Nudge",cls:"timeline-slider-header"}),X.createEl("p",{text:"Slide left/right to move the node on the timeline. Release to sync changes to frontmatter.",cls:"setting-item-description"});let E=X.createDiv({cls:"timeline-slider-container"}).createEl("input",{cls:"storyflow-nudge-slider"});E.type="range",E.style.width="100%";let $=t.x;E.min=($-1e3).toString(),E.max=($+1e3).toString(),E.value=$.toString(),E.addEventListener("input",()=>{let u=parseInt(E.value,10);t.setData({...t.getData(),x:u}),S&&S.requestSave()}),E.addEventListener("change",async()=>{let u=t.x;E.min=(u-1e3).toString(),E.max=(u+1e3).toString(),E.value=u.toString(),new M.Notice("Slider released. Updating node date..."),S&&await this.plugin.canvasManager.syncStoryboard(S)});let x=e.createDiv({cls:"storyflow-inspector-card"});x.createEl("h4",{text:"Properties"});let C=new M.Setting(x).setName("Story Arc").setDesc("Which lane or plotline this scene belongs to."),H=()=>{C.clear(),C.setName("Story Arc").setDesc("Which lane or plotline this scene belongs to."),C.addDropdown(u=>{let y=tt(this.app,"story-arc");u.addOption("","-- Select an Arc --"),y.forEach(g=>u.addOption(g,g)),u.addOption("__CREATE__","+ Create New Arc..."),y.includes(i)?u.setValue(i):i&&(u.addOption(i,i),u.setValue(i)),u.onChange(async g=>{if(g==="__CREATE__"){At();return}if(g!==i){await F(this.app,t.file,"story-arc",g);let D=this.plugin.canvasManager.getActiveCanvas();D&&await this.plugin.canvasManager.buildStoryboard(D)}})})},At=()=>{C.clear(),C.setName("New Story Arc").setDesc("Type a new lane name, then press Enter."),C.addText(u=>{u.setPlaceholder("e.g. Subplot B");let y=async()=>{let g=u.getValue().trim();if(g&&g!==i){await F(this.app,t.file,"story-arc",g);let D=this.plugin.canvasManager.getActiveCanvas();D&&await this.plugin.canvasManager.buildStoryboard(D)}};u.inputEl.addEventListener("blur",y),u.inputEl.addEventListener("keydown",g=>{g.key==="Enter"&&(y(),u.inputEl.blur(),setTimeout(()=>{this.pollSelection()},50)),g.key==="Escape"&&H()}),setTimeout(()=>u.inputEl.focus(),50)})};H(),new M.Setting(x).setName("Story Date").setDesc(Z).addText(u=>{u.setValue(c).setPlaceholder("YYYY-MM-DD");let y=async()=>{let g=u.getValue();if(g!==c){let D=this.plugin.settings.dateSettings.dateParserRegex;if(new RegExp(D).test(g)){await F(this.app,t.file,"story-date",g);let L=this.plugin.canvasManager.getActiveCanvas();L&&await this.plugin.canvasManager.buildStoryboard(L)}else new M.Notice("Invalid date format for Storyboard")}};u.inputEl.addEventListener("blur",y),u.inputEl.addEventListener("keydown",g=>{g.key==="Enter"&&(y(),u.inputEl.blur())})});let ut=x.createDiv(),st=ut.createEl("div",{text:`Tension Level: ${d}`});st.style.fontWeight="bold",st.style.marginBottom="4px",new M.Setting(ut).setName("Dramatic Tension").setDesc("1 (Calm) to 10 (High Action)").addSlider(u=>{u.setLimits(1,10,1).setValue(d).setDynamicTooltip().onChange(async y=>{d=y,await F(this.app,t.file,"tension",y),S&&this.plugin.canvasManager.sortStoryboard(S)}),u.sliderEl.addEventListener("input",()=>{let y=parseInt(u.sliderEl.value);if(st.setText(`Tension Level: ${y}`),t.nodeEl){for(let g=1;g<=10;g++)t.nodeEl.classList.remove(`storyboard-tension-${g}`);t.nodeEl.classList.add(`storyboard-tension-${y}`)}})});let gt=e.createDiv({cls:"storyflow-inspector-card"});gt.createEl("h4",{text:"Dependencies"});let Xt=new M.Setting(gt).addButton(u=>u.setButtonText("Show Dependencies").setTooltip("View and delete active dependencies").onClick(()=>{new pt(this.app,this.plugin,t,t.file,f,()=>{this.renderInspector(t)}).open()})).addButton(u=>u.setButtonText("+ Add Dependency").setCta().onClick(()=>{new W(this.plugin,t.file,()=>{this.renderInspector(t)}).open()}))}compareAbstractDates(t,e){let n=Math.max(t.length,e.length);for(let a=0;a<n;a++){let s=t[a]||0,o=e[a]||0;if(s!==o)return s-o}return 0}clearConstraintOverlays(){document.querySelectorAll(".storyflow-constraint-overlay").forEach(t=>t.remove())}renderConstraintOverlays(t,e,n){if(!t)return;this.clearConstraintOverlays();let a=t.nodeEl;if(!a)return;if(e!==-1/0){let c=document.createElement("div");c.addClasses(["storyflow-constraint-overlay","invalid"]),Object.assign(c.style,{left:"-100000px",width:`${1e5+e}px`}),a.appendChild(c)}if(n!==1/0){let c=document.createElement("div");c.addClasses(["storyflow-constraint-overlay","invalid"]),Object.assign(c.style,{left:`${n}px`,width:"100000px"}),a.appendChild(c)}let s=e===-1/0?-1e5:e,o=n===1/0?1e5:n,i=document.createElement("div");i.addClasses(["storyflow-constraint-overlay","valid"]),Object.assign(i.style,{left:`${s}px`,width:`${o-s}px`}),a.appendChild(i)}},pt=class extends M.Modal{plugin;sourceFile;node;currentDeps;onComplete;constructor(t,e,n,a,s,o){super(t),this.plugin=e,this.node=n,this.sourceFile=a,this.currentDeps=s,this.onComplete=o}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:`Dependencies for ${this.sourceFile.basename}`});let e=t.createDiv({cls:"storyboard-deps-list"});e.style.maxHeight="400px",e.style.padding="10px",e.style.overflowY="auto",this.currentDeps.length===0?e.createEl("p",{text:"No dependencies set. Use the Add Dependency button to create one.",cls:"storyflow-subtext"}):this.currentDeps.forEach(n=>{let a=e.createEl("div",{cls:`storyflow-dep-tag dep-${n.type}`});a.style.marginBottom="8px",a.style.display="flex",a.style.justifyContent="space-between",a.style.alignItems="center",a.setText(`${n.type==="before"?"Before:":"After:"} ${n.basename}`);let s=a.createEl("span",{text:"\u2715",cls:"storyflow-dep-remove clickable-icon"});s.style.marginLeft="10px",s.style.color="var(--text-error)",s.style.fontWeight="bold",s.style.cursor="pointer",s.addEventListener("click",async o=>{o.stopPropagation();let i=`${n.basename}:${n.type}`,c=n.type==="before"?"after":"before",d=`${this.sourceFile.basename}:${c}`;await this.app.fileManager.processFrontMatter(this.sourceFile,f=>{let h=f["story-deps"];Array.isArray(h)&&(f["story-deps"]=h.filter(m=>m!==i),f["story-deps"].length===0&&delete f["story-deps"])});let l=this.app.vault.getMarkdownFiles().find(f=>f.basename===n.basename);l&&await this.app.fileManager.processFrontMatter(l,f=>{let h=f["story-deps"];Array.isArray(h)&&(f["story-deps"]=h.filter(m=>m!==d),f["story-deps"].length===0&&delete f["story-deps"])}),new M.Notice(`Removed dependency: ${n.basename}`);let p=this.plugin.canvasManager.getActiveCanvas();p&&await this.plugin.canvasManager.buildStoryboard(p),this.currentDeps=this.currentDeps.filter(f=>f.basename!==n.basename),this.onOpen()})})}onClose(){let{contentEl:t}=this;t.empty(),this.onComplete()}};function Et(r,t){let e=Object.keys(t).map(n=>Yt(r,n,t[n]));return e.length===1?e[0]:function(){e.forEach(n=>n())}}function Yt(r,t,e){let n=r[t],a=r.hasOwnProperty(t),s=a?n:function(){return Object.getPrototypeOf(r)[t].apply(this,arguments)},o=e(s);return n&&Object.setPrototypeOf(o,n),Object.setPrototypeOf(i,o),r[t]=i,c;function i(...d){return o===s&&r[t]===i&&c(),o.apply(this,d)}function c(){r[t]===i&&(a?r[t]=s:delete r[t]),o!==s&&(o=s,Object.setPrototypeOf(i,n||Function))}}function xt(r){let t=!1,e=()=>{if(t)return;let a=r.app.workspace.getLeavesOfType("canvas")?.[0]?.view;if(!a||!a.canvas)return;let s=Object.getPrototypeOf(a.canvas);s&&s.requestSave&&r.register(Et(s,{requestSave:o=>function(...i){let c=o.call(this,...i);t||this.nodes?.values()?.next()?.value&&(t=!0,r.app.workspace.offref(n));let d=r.app.workspace.getLeavesOfType(R);for(let l of d)l.view instanceof G&&l.view.pollSelection();return c}}))};r.app.workspace.onLayoutReady(e);let n=r.app.workspace.on("active-leaf-change",e);r.registerEvent(n)}var at=class extends Tt.Plugin{canvasManager;settings;async onload(){await this.loadSettings(),this.canvasManager=new et(this.app,this.settings.dateSettings,this.settings.layoutConfig),this.addSettingTab(new nt(this.app,this)),this.registerView(R,t=>new G(t,this)),this.addRibbonIcon("list","Open Storyboard Inspector",()=>{this.activateInspectorView()}),xt(this),this.addCommand({id:"storyboard-set-date",name:"Set story date on current note",editorCallback:(t,e)=>{e.file&&new _(this,e.file).open()}}),this.addCommand({id:"storyboard-set-arc",name:"Set story arc on current note",editorCallback:(t,e)=>{e.file&&new B(this,e.file).open()}}),this.addCommand({id:"storyboard-set-tension",name:"Set story tension (1-10) on current note",editorCallback:(t,e)=>{e.file&&new U(this,e.file).open()}}),this.addCommand({id:"storyboard-tag-scene",name:"Tag scene (set date + arc)",editorCallback:(t,e)=>{e.file&&lt(this,e.file)}}),this.addCommand({id:"storyboard-build",name:"Build storyboard (sort + connect + cross-link)",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.buildStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sort",name:"Sort storyboard by date",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.sortStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-connect",name:"Connect scenes chronologically",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectChronologically(e),!0):!1}}),this.addCommand({id:"storyboard-crosslink",name:"Add cross-link edges from [[wikilinks]]",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectByLinks(e),!0):!1}}),this.addCommand({id:"storyboard-play",name:"Play storyboard",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.playStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sync",name:"Sync canvas to notes",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.syncStoryboard(e),!0):!1}})}async loadSettings(){this.settings=Object.assign({},Dt,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.canvasManager&&(this.canvasManager.dateSettings=this.settings.dateSettings,this.canvasManager.layoutConfig=this.settings.layoutConfig)}async activateInspectorView(){let{workspace:t}=this.app,e=null,n=t.getLeavesOfType(R);n.length>0?e=n[0]:(e=t.getRightLeaf(!1),e&&await e.setViewState({type:R,active:!0})),e&&t.revealLeaf(e)}onunload(){}};
