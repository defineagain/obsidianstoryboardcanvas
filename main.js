var Q=Object.defineProperty;var mt=Object.getOwnPropertyDescriptor;var ht=Object.getOwnPropertyNames;var yt=Object.prototype.hasOwnProperty;var V=(o,t)=>()=>(o&&(t=o(o=0)),t);var et=(o,t)=>{for(var e in t)Q(o,e,{get:t[e],enumerable:!0})},vt=(o,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of ht(t))!yt.call(o,a)&&a!==e&&Q(o,a,{get:()=>t[a],enumerable:!(n=mt(t,a))||n.enumerable});return o};var St=o=>vt(Q({},"__esModule",{value:!0}),o);var O,k,G=V(()=>{O={layoutMode:"absolute",xScale:10,arcSpacing:500,nodeWidth:400,nodeHeight:300,nodeGapX:50},k={dateParserRegex:"(?<y>-?\\d+)[-/.](?<M>\\d+)[-/.](?<d>\\d+)",dateParserGroupPriority:"y,M,d",dateDisplayFormat:"{y}-{M}-{d}",dateTokenConfiguration:[{name:"y",type:"NUMBER",minLeght:4,displayWhenZero:!0,hideSign:!1,formatting:[]},{name:"M",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]},{name:"d",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]}],applyAdditonalConditionFormatting:!1}});function Ct(o){return o.type==="NUMBER"}function wt(o){return o.type==="STRING"}function Dt(o,t,e){switch(o){case"GREATER":return t>e;case"LESS":return t<e;case"EQUAL":return t===e;case"NOTEQUAL":return t!==e;case"GREATEROREQUAL":return t>=e;case"LESSOREQUAL":return t<=e;default:return!1}}function xt(o,t){let e=t.minLeght<0?0:t.minLeght,n=Math.abs(o).toString();for(;n.length<e;)n="0"+n;return!t.hideSign&&o<0&&(n=`-${n}`),n}function Tt(o,t){return t.dictionary[o]??String(o)}function Et(o,t){if(Ct(t))return xt(o,t);if(wt(t))return Tt(o,t);throw new Error("[Storyflow] Corrupted date token configuration")}function At(o,t,e,n){return n?e.formatting.reduce((a,r)=>(r.conditionsAreExclusive?r.evaluations.some.bind(r.evaluations):r.evaluations.every.bind(r.evaluations))(({condition:c,value:d})=>Dt(c,t,d))?r.format.replace("{value}",a):a,o):o}function x(o,t){let e=t.dateParserGroupPriority.split(","),n=t.dateDisplayFormat.toString();return e.forEach((a,r)=>{let s=a.trim(),i=t.dateTokenConfiguration.find(({name:c})=>c===s);if(!i)throw new Error(`[Storyflow] No date token configuration found for "${s}"`);n=n.replace(`{${s}}`,At(Et(o[r],i),o[r],i,t.applyAdditonalConditionFormatting))}),n}var W=V(()=>{G()});function N(o,t){let e=Math.max(o.length,t.length);for(let n=0;n<e;n++){let a=o[n]??0,r=t[n]??0;if(a!==r)return a-r}return 0}function Mt(o){let t=[1,30,365,365e3,365e6],e=0;for(let n=0;n<o.length;n++){let a=o.length-1-n,r=t[a]??Math.pow(10,a+2);e+=(o[n]??0)*r}return e}function rt(o,t=O){let e=new Map;if(o.length===0)return e;let n=[...o].sort((c,d)=>N(c.date,d.date)),a=n.map(c=>Mt(c.date)),r=Math.min(...a),s=[];for(let c of n)s.includes(c.arc)||s.push(c.arc);let i=new Map;for(let c=0;c<n.length;c++){let d=n[c],u=s.indexOf(d.arc),l;if(t.layoutMode==="ordered")l=c*(t.nodeWidth+t.nodeGapX*2);else{l=(a[c]-r)*t.xScale;let m=i.get(d.arc);if(m!==void 0){let h=m+t.nodeWidth+t.nodeGapX;l<h&&(l=h)}i.set(d.arc,l)}let y=u*t.arcSpacing;e.set(d.nodeId,{x:l,y})}return e}var j=V(()=>{G()});async function A(o,t,e,n){await o.fileManager.processFrontMatter(t,a=>{a[e]=n})}function z(o,t){let e=new Set,n=o.vault.getMarkdownFiles();for(let a of n){let r=o.metadataCache.getFileCache(a);if(!r?.frontmatter)continue;let s=r.frontmatter[t];typeof s=="string"&&s.trim()&&e.add(s.trim())}return[...e].sort()}function st(o,t){new P(o,t,()=>{new X(o,t).open()}).open()}var w,P,X,Y=V(()=>{w=require("obsidian");P=class extends w.Modal{file;onComplete;value;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n;let a=t.app.metadataCache.getFileCache(e);this.value=a?.frontmatter?.["story-date"]?.toString()??""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Set date: ${this.file.basename}`}),new w.Setting(t).setName("Story date").setDesc("Format: YYYY-MM-DD (e.g. 2024-06-15) or fantasy format").addText(e=>{e.setPlaceholder("1000-03-15").setValue(this.value).onChange(n=>{this.value=n}),e.inputEl.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),this.save())}),setTimeout(()=>e.inputEl.focus(),50)}),new w.Setting(t).addButton(e=>e.setButtonText("Save").setCta().onClick(()=>this.save()))}async save(){let t=this.value.trim();if(!t){new w.Notice("Date cannot be empty.");return}let e=this.plugin.settings.dateSettings.dateParserRegex;if(!new RegExp(e).test(t)){new w.Notice(`Invalid date format. Needs to match regex:
${e}`);return}await A(this.app,this.file,"story-date",t),new w.Notice(`Set story-date: ${t}`),this.close(),this.onComplete()}onClose(){this.contentEl.empty()}},X=class extends w.SuggestModal{file;onComplete;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n,this.setPlaceholder("Type an arc name or select existing..."),this.setInstructions([{command:"\u2191\u2193",purpose:"navigate"},{command:"\u21B5",purpose:"select or create new"},{command:"esc",purpose:"cancel"}])}getSuggestions(t){let e=z(this.app,"story-arc"),n=t.toLowerCase().trim(),a=e.filter(r=>r.toLowerCase().includes(n));return n&&!e.some(r=>r.toLowerCase()===n)&&a.unshift(`+ Create "${t.trim()}"`),a.length>0?a:[`+ Create "${t.trim()||"default"}"`]}renderSuggestion(t,e){e.createEl("span",{text:t})}async onChooseSuggestion(t){let e=t,n=t.match(/^\+ Create "(.+)"$/);n&&(e=n[1]),await A(this.app,this.file,"story-arc",e),new w.Notice(`Set story-arc: ${e}`),this.onComplete()}}});var it={};et(it,{SyncConfirmationModal:()=>Z,calculateSyncChanges:()=>kt});async function kt(o,t,e,n,a){let r=[],s=new Map;for(let u of e){let l=t.nodes.get(u.nodeId);l&&(s.has(u.arc)||s.set(u.arc,[]),s.get(u.arc).push(l.getData().y))}let i=new Map;for(let[u,l]of s.entries()){let y=l.reduce((m,h)=>m+h,0)/l.length;i.set(u,y)}let d=Array.from(t.nodes.entries()).map(([u,l])=>({id:u,data:l.getData()})).filter(u=>u.data.type==="file"&&u.data.file).sort((u,l)=>u.data.x-l.data.x).map(u=>u.id);for(let u of e){let l=t.nodes.get(u.nodeId);if(!l)continue;let y=l.getData(),m=!1,h,g,f=[],p=u.arc,v=1/0;for(let[b,C]of i.entries()){let tt=Math.abs(y.y-C);tt<v&&(v=tt,p=b)}p!==u.arc&&v<n.arcSpacing/2&&(h=p,f.push(`Arc changed from "${u.arc}" to "${h}"`),m=!0);let T=d.indexOf(u.nodeId),_=d[T-1],M=d[T+1],D=e.find(b=>b.nodeId===_),E=e.find(b=>b.nodeId===M),K=!1;if(D&&N(u.date,D.date)<=0&&(K=!0),E&&N(u.date,E.date)>=0&&(K=!0),K){let b=[...u.date],C=b.length-1;D&&E?(b[C]=Math.floor((D.date[C]+E.date[C])/2),b[C]<=D.date[C]&&(b[C]=D.date[C]+1)):D?b[C]=D.date[C]+1:E&&(b[C]=E.date[C]-1),g=b,f.push(`Sequence moved: expected bounds broken. Suggesting new date: ${x(g,a)}`),m=!0}m&&r.push({scene:u,newArc:h,newDate:g,description:f.join("; ")})}return r}var R,Z,ct=V(()=>{R=require("obsidian");W();j();Y();Z=class extends R.Modal{changes;dateSettings;onConfirm;constructor(t,e,n,a){super(t),this.changes=e,this.dateSettings=n,this.onConfirm=a}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:`Sync ${this.changes.length} Changes to Notes`}),t.createEl("p",{text:"The following frontmatter updates will be applied based on your canvas dragging:"});let e=t.createEl("ul",{cls:"storyflow-sync-list"});for(let n of this.changes){let a=e.createEl("li");a.createEl("strong",{text:n.scene.title+": "}),a.createEl("span",{text:n.description})}new R.Setting(t).addButton(n=>n.setButtonText("Cancel").onClick(()=>this.close())).addButton(n=>n.setButtonText("Apply Changes").setCta().onClick(async()=>{this.close();let a=0;for(let r of this.changes){if(r.newArc&&await A(this.app,r.scene.file,"story-arc",r.newArc),r.newDate){let s=x(r.newDate,this.dateSettings);await A(this.app,r.scene.file,"story-date",s)}a++}new R.Notice(`Successfully synced ${a} notes from canvas.`),this.onConfirm()}))}onClose(){this.contentEl.empty()}}});var Ft={};et(Ft,{default:()=>H});module.exports=St(Ft);var ft=require("obsidian");var S=require("obsidian");G();function nt(o,t,e){if(o.frontmatter)return typeof o.frontmatter[t]===e?o.frontmatter[t]:void 0}function bt(o,t,e){try{let n=new RegExp(e).exec(t);if(!n?.groups)return;let a=[];for(let r of o){let s=n.groups[r.trim()];if(s===void 0)return;let i=parseInt(s,10);if(isNaN(i))return;a.push(i)}return a}catch{return}}function U(o,t,e){if(!o.frontmatter)return;let n=o.frontmatter[t];if(n==null)return;let a=e.dateParserGroupPriority.split(",");if(typeof n=="number"){let y=[...Array(Math.max(0,a.length-1))].map(()=>1);return[n,...y]}if(n instanceof Date)return[n.getFullYear(),n.getMonth()+1,n.getDate()];if(typeof n=="object"&&typeof n.toISOString=="function")try{let y=new Date(n.toISOString());return[y.getFullYear(),y.getMonth()+1,y.getDate()]}catch{}let r;typeof n=="string"?r=n.trim():r=String(n).trim();let s=r.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);if(s)return[parseInt(s[1],10),parseInt(s[2],10),parseInt(s[3],10)];let i=r.match(/^(-?\d+)\/(\d{1,2})\/(\d{1,2})/);if(i)return[parseInt(i[1],10),parseInt(i[2],10),parseInt(i[3],10)];let c=r.match(/^(-?\d+)\.(\d{1,2})\.(\d{1,2})/);if(c)return[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)];let d=r.match(/\w+ (\w+) (\d+) (\d{4})/);if(d){let m={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[d[1]];if(m)return[parseInt(d[3],10),m,parseInt(d[2],10)]}let u=r.replace(/[/.]/g,"-"),l=bt(a,u,e.dateParserRegex);if(l)return l;console.warn(`[Storyboard Canvas] Could not parse '${t}' value:`,n,`(type: ${typeof n})`)}function at(o,t="story-arc"){return nt(o,t,"string")??"default"}function ot(o,t="story-title"){return nt(o,t,"string")??""}W();j();function dt(o=16){return Math.random().toString(36).substring(2,2+o/2)+Math.random().toString(36).substring(2,2+o/2)}var B=class{app;dateSettings;layoutConfig;constructor(t,e=k,n=O){this.app=t,this.layoutConfig=n,this.dateSettings=e}getActiveCanvas(){let t=this.app.workspace.getLeavesOfType("canvas");return t.length===0?null:t[0].view.canvas??null}async extractScenes(t){let e=[];for(let[n,a]of t.nodes){let r=a.getData();if(r.type!=="file"||!r.file)continue;let s=this.app.vault.getAbstractFileByPath(r.file);if(!(s instanceof S.TFile))continue;let i=this.app.metadataCache.getFileCache(s);if(!i){console.warn(`[Storyboard] No metadata cache for: ${s.path}`);continue}let c=i.frontmatter?.["story-date"];if(c==null){console.log(`[Storyboard] Skipping ${s.basename}: no story-date in frontmatter`);continue}console.log(`[Storyboard] ${s.basename}: story-date raw =`,c,`(type: ${typeof c}, isDate: ${c instanceof Date})`);let d=U(i,"story-date",this.dateSettings);if(!d){console.warn(`[Storyboard] FAILED to parse story-date for: ${s.basename}, raw value:`,c);continue}let u=U(i,"story-end-date",this.dateSettings),l=at(i),y=ot(i)||s.basename;console.log(`[Storyboard] \u2713 ${s.basename}: date=[${d}], arc="${l}"`),e.push({nodeId:n,file:s,date:d,endDate:u,arc:l,title:y})}return e}async sortStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new S.Notice("No scenes with story-date found on this canvas.");return}let n=rt(e,this.layoutConfig);for(let[a,r]of n){let s=t.nodes.get(a);if(!s)continue;let i=s.getData();s.setData({...i,x:r.x,y:r.y,width:this.layoutConfig.nodeWidth,height:this.layoutConfig.nodeHeight})}t.requestSave(),new S.Notice(`Sorted ${e.length} scenes by date.`)}async connectChronologically(t){let e=await this.extractScenes(t);if(e.length<2){new S.Notice("Need at least 2 scenes with story-date to connect.");return}let n=new Map;for(let s of e){let i=n.get(s.arc)??[];i.push(s),n.set(s.arc,i)}let a=0,r=t.getData();for(let[,s]of n){s.sort((i,c)=>N(i.date,c.date));for(let i=0;i<s.length-1;i++){let c=s[i],d=s[i+1];if(r.edges.some(y=>y.fromNode===c.nodeId&&y.toNode===d.nodeId))continue;let l=x(d.date,this.dateSettings);r.edges.push({id:dt(),fromNode:c.nodeId,toNode:d.nodeId,fromSide:"right",toSide:"left",toEnd:"arrow",label:l}),a++}}a>0&&(t.setData(r),t.requestSave()),new S.Notice(`Connected ${a} scene pairs across ${n.size} arc(s).`)}async connectByLinks(t){let e=this.app.metadataCache.resolvedLinks,n=t.getData(),a=new Map;for(let[i,c]of t.nodes){let d=c.getData();d.type==="file"&&d.file&&a.set(d.file,i)}let r=new Set;for(let i of n.edges)r.add(`${i.fromNode}->${i.toNode}`);let s=0;for(let[i,c]of a){let d=e[i];if(d)for(let u in d){let l=a.get(u);if(!l||l===c)continue;let y=`${c}->${l}`;r.has(y)||(n.edges.push({id:dt(),fromNode:c,toNode:l,fromSide:"bottom",toSide:"top",toEnd:"arrow",styleAttributes:{"edge-style":"dotted"}}),r.add(y),s++)}}s>0&&(t.setData(n),t.requestSave()),new S.Notice(`Created ${s} cross-link edges from [[wikilinks]].`)}async buildStoryboard(t){let e=t.nodes.size,n=await this.extractScenes(t),a=e-n.length;if(n.length===0){new S.Notice(`No scenes found. ${e} nodes on canvas but none have story-date frontmatter. Use "Tag scene" command on each note first.`);return}a>0&&new S.Notice(`Found ${n.length} tagged scenes (${a} nodes skipped \u2014 no story-date).`),this.removeMarkerNodes(t),await this.sortStoryboard(t),await this.connectChronologically(t),await this.connectByLinks(t),this.addVisualMarkers(t,n),new S.Notice(`Storyboard built: ${n.length} scenes, sorted + connected + labelled.`)}MARKER_PREFIX="storyboard-marker-";removeMarkerNodes(t){let e=t.getData();e.nodes=e.nodes.filter(n=>!n.id?.startsWith(this.MARKER_PREFIX)),t.setData(e),t.requestSave()}addVisualMarkers(t,e){let n=t.getData(),a=new Map,r=new Map;for(let h of e){let g=t.nodes.get(h.nodeId);if(!g)continue;let f=g.getData();a.has(h.arc)||a.set(h.arc,f.y);let p=x(h.date,this.dateSettings);r.has(p)||r.set(p,f.x)}let s=200,i=60,c=Math.min(...a.values())-i-80,u=Math.min(...r.values())-s-60,l=0;for(let[h,g]of a){let f=["1","2","3","4","5","6"];n.nodes.push({id:`${this.MARKER_PREFIX}arc-${l}`,type:"text",text:`## ${h}`,x:u,y:g+this.layoutConfig.nodeHeight/2-i/2,width:s,height:i,color:f[l%f.length]}),l++}let y=0;for(let[h,g]of r)n.nodes.push({id:`${this.MARKER_PREFIX}date-${y}`,type:"text",text:`**${h}**`,x:g+this.layoutConfig.nodeWidth/2-s/2,y:c,width:s,height:i,color:"0"}),y++;let m=40;for(let h of e){let g=t.nodes.get(h.nodeId);if(!g)continue;let f=g.getData(),p=x(h.date,this.dateSettings);n.nodes.push({id:`${this.MARKER_PREFIX}nodelabel-${h.nodeId}`,type:"text",text:p,x:f.x,y:f.y-m-10,width:this.layoutConfig.nodeWidth,height:m,color:"0"})}t.setData(n),t.requestSave()}async syncStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new S.Notice("No scenes with story-date found.");return}let{calculateSyncChanges:n,SyncConfirmationModal:a}=await Promise.resolve().then(()=>(ct(),it)),r=await n(this.app,t,e,this.layoutConfig,this.dateSettings);if(r.length===0){new S.Notice("No drag-and-drop changes detected.");return}new a(this.app,r,this.dateSettings,()=>{this.buildStoryboard(t)}).open()}async playStoryboard(t,e=1500){let n=await this.extractScenes(t);if(n.length===0){new S.Notice("No scenes with story-date found.");return}n.sort((a,r)=>N(a.date,r.date)),new S.Notice(`Playing ${n.length} scenes...`);for(let a of n){let r=t.nodes.get(a.nodeId);if(!r)continue;let s=r.getData();t.zoomToBbox({minX:s.x-50,minY:s.y-50,maxX:s.x+s.width+50,maxY:s.y+s.height+50}),await new Promise(i=>setTimeout(i,e))}new S.Notice("Playback complete.")}};Y();var I=require("obsidian");G();var lt={layoutConfig:O,dateSettings:k},q=class extends I.PluginSettingTab{plugin;constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Storyboard Canvas Settings"}),new I.Setting(t).setName("Layout Mode").setDesc("Absolute: position nodes strictly by time elapsed on X-axis. Ordered: distribute nodes evenly in sequence on X-axis.").addDropdown(e=>e.addOption("absolute","Absolute Time Graph").addOption("ordered","Ordered Sequence").setValue(this.plugin.settings.layoutConfig.layoutMode).onChange(async n=>{this.plugin.settings.layoutConfig.layoutMode=n,await this.plugin.saveSettings()})),new I.Setting(t).setName("Date Parser Regex").setDesc("Regex with named capture groups (?<y>, ?<M>, ?<d>) to extract dates from story-date.").addText(e=>e.setPlaceholder(k.dateParserRegex).setValue(this.plugin.settings.dateSettings.dateParserRegex).onChange(async n=>{this.plugin.settings.dateSettings.dateParserRegex=n.trim()||k.dateParserRegex,await this.plugin.saveSettings()})),new I.Setting(t).setName("Date Display Format").setDesc("How dates appear on canvas labels. Use {y}, {M}, {d}.").addText(e=>e.setPlaceholder(k.dateDisplayFormat).setValue(this.plugin.settings.dateSettings.dateDisplayFormat).onChange(async n=>{this.plugin.settings.dateSettings.dateDisplayFormat=n.trim()||k.dateDisplayFormat,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Layout Dimensions"}),new I.Setting(t).setName("X Scale (Absolute Mode)").setDesc("Pixels per date ordinal unit in absolute time graph mode.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.xScale)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.xScale=a,await this.plugin.saveSettings())})),new I.Setting(t).setName("Arc Lane Spacing (Y-Axis)").setDesc("Pixels between arc lanes on the Y-axis.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.arcSpacing)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.arcSpacing=a,await this.plugin.saveSettings())}))}};var F=require("obsidian");W();Y();var L="storyboard-inspector-view",$=class extends F.ItemView{plugin;pollInterval=null;activeNodeId=null;container;contentDiv;constructor(t,e){super(t),this.plugin=e}getViewType(){return L}getDisplayText(){return"Storyboard Inspector"}getIcon(){return"list"}async onOpen(){let{containerEl:t}=this;t.empty(),t.addClass("storyboard-inspector-view"),t.createEl("h3",{text:"Storyboard Inspector"}),this.container=t.createDiv({cls:"inspector-content"}),this.renderEmptyState(),this.pollInterval=window.setInterval(()=>this.pollSelection(),300)}async onClose(){this.pollInterval!==null&&(window.clearInterval(this.pollInterval),this.pollInterval=null),this.container.empty()}renderEmptyState(){this.container.empty(),this.container.createEl("p",{text:"Select a single file node on the canvas to inspect it.",cls:"empty-state"}),this.activeNodeId=null}pollSelection(){if(this.container?.contains(document.activeElement))return;let t=this.plugin.canvasManager.getActiveCanvas();if(!t){this.activeNodeId!==null&&this.renderEmptyState();return}let e=Array.from(t.selection);if(e.length!==1){this.activeNodeId!==null&&this.renderEmptyState();return}let n=e[0];if(n.getData().type!=="file"||!n.file){this.activeNodeId!==null&&this.renderEmptyState();return}let a=n.getData().id;this.activeNodeId!==a&&(this.activeNodeId=a,this.renderInspector(n))}async renderInspector(t){if(this.container.empty(),!t.file)return;this.container.createEl("h4",{text:t.file.basename});let e=this.app.metadataCache.getFileCache(t.file),n=e?.frontmatter||{},a=n["story-arc"]?.toString()||"",r=n["story-date"]?.toString()||"",s=U(e,"story-date",this.plugin.settings.dateSettings);s&&(r=x(s,this.plugin.settings.dateSettings));let i="Format must match plugin settings regex.",c=this.plugin.canvasManager.getActiveCanvas();try{if(a&&r&&c){let f=(await this.plugin.canvasManager.extractScenes(c)).filter(v=>v.arc===a).sort((v,T)=>{let _=Math.max(v.date.length,T.date.length);for(let M=0;M<_;M++){let D=v.date[M]||0,E=T.date[M]||0;if(D!==E)return D-E}return 0}),p=f.findIndex(v=>v.nodeId===t.getData().id);if(p!==-1){let v=p>0?f[p-1]:null,T=p<f.length-1?f[p+1]:null,_=v?`${v.title} (${x(v.date,this.plugin.settings.dateSettings)})`:"None",M=T?`${T.title} (${x(T.date,this.plugin.settings.dateSettings)})`:"None";i=`Preceding: ${_}
Proceeding: ${M}`}}}catch{}let d=new F.Setting(this.container).setName("Story Arc").setDesc("Which lane or plotline this scene belongs to."),u=()=>{d.clear(),d.setName("Story Arc").setDesc("Which lane or plotline this scene belongs to."),d.addDropdown(g=>{let f=z(this.app,"story-arc");g.addOption("","-- Select an Arc --"),f.forEach(p=>g.addOption(p,p)),g.addOption("__CREATE__","+ Create New Arc..."),f.includes(a)?g.setValue(a):a&&(g.addOption(a,a),g.setValue(a)),g.onChange(async p=>{if(p==="__CREATE__"){l();return}p!==a&&await A(this.app,t.file,"story-arc",p)})})},l=()=>{d.clear(),d.setName("New Story Arc").setDesc("Type a new lane name, then press Enter."),d.addText(g=>{g.setPlaceholder("e.g. Subplot B");let f=async()=>{let p=g.getValue().trim();p&&p!==a&&await A(this.app,t.file,"story-arc",p)};g.inputEl.addEventListener("blur",f),g.inputEl.addEventListener("keydown",p=>{p.key==="Enter"&&(f(),g.inputEl.blur(),setTimeout(()=>{this.pollSelection()},50)),p.key==="Escape"&&u()}),setTimeout(()=>g.inputEl.focus(),50)})};u(),new F.Setting(this.container).setName("Story Date").setDesc(i).addText(g=>{g.setValue(r).setPlaceholder("YYYY-MM-DD");let f=async()=>{let p=g.getValue();if(p!==r){let v=this.plugin.settings.dateSettings.dateParserRegex;new RegExp(v).test(p)?await A(this.app,t.file,"story-date",p):new F.Notice("Invalid date format for Storyboard")}};g.inputEl.addEventListener("blur",f),g.inputEl.addEventListener("keydown",p=>{p.key==="Enter"&&(f(),g.inputEl.blur())})}),this.container.createEl("h4",{text:"Timeline Nudge",cls:"timeline-slider-header"}),this.container.createEl("p",{text:"Slide left/right to move the node on the timeline. Release to sync changes to frontmatter.",cls:"setting-item-description"});let m=this.container.createDiv({cls:"timeline-slider-container"}).createEl("input");m.type="range";let h=t.x;m.min=(h-1e3).toString(),m.max=(h+1e3).toString(),m.value=h.toString(),m.addEventListener("input",()=>{let g=parseInt(m.value,10);t.setData({...t.getData(),x:g}),c&&c.requestSave()}),m.addEventListener("change",async()=>{let g=t.x;m.min=(g-1e3).toString(),m.max=(g+1e3).toString(),m.value=g.toString(),new F.Notice("Slider released. Updating node date..."),c&&await this.plugin.canvasManager.syncStoryboard(c)})}};function J(o,t){let e=Object.keys(t).map(n=>It(o,n,t[n]));return e.length===1?e[0]:function(){e.forEach(n=>n())}}function It(o,t,e){let n=o[t],a=o.hasOwnProperty(t),r=a?n:function(){return Object.getPrototypeOf(o)[t].apply(this,arguments)},s=e(r);return n&&Object.setPrototypeOf(s,n),Object.setPrototypeOf(i,s),o[t]=i,c;function i(...d){return s===r&&o[t]===i&&c(),s.apply(this,d)}function c(){o[t]===i&&(a?o[t]=r:delete o[t]),s!==r&&(s=r,Object.setPrototypeOf(i,n||Function))}}var ut=require("obsidian");Y();function gt(o,t){let e=t.canvasManager.getActiveCanvas();if(!e)return;let n=Array.from(e.selection);if(n.length!==1)return;let a=n[0];if(a.getData().type!=="file"||!a.file||o.querySelector(".storyboard-menu-btn"))return;let r=document.createElement("button");r.addClass("clickable-icon"),r.addClass("canvas-node-menu-item"),r.addClass("storyboard-menu-btn"),r.setAttribute("aria-label","Set story-date"),(0,ut.setIcon)(r,"calendar"),r.addEventListener("click",()=>{new P(t,a.file).open()}),o.appendChild(r)}function pt(o){let t=!1,e=()=>{if(t)return;let a=o.app.workspace.getLeavesOfType("canvas")?.[0]?.view;if(!a||!a.canvas)return;let r=Object.getPrototypeOf(a.canvas);if(!r)return;r.requestSave&&o.register(J(r,{requestSave:i=>function(...c){let d=i.call(this,...c),u=o.app.workspace.getLeavesOfType(L);for(let l of u)l.view instanceof $&&l.view.pollSelection();return d}}));let s=a.canvas.nodes?.values()?.next()?.value;if(s){let i=Object.getPrototypeOf(Object.getPrototypeOf(s));i&&i.showMenu&&(o.register(J(i,{showMenu:c=>function(...d){let u=c.call(this,...d);return setTimeout(()=>{let l=document.body.querySelector(".canvas-node-menu");l&&gt(l,o)},0),u}})),t=!0,o.app.workspace.offref(n))}};o.app.workspace.onLayoutReady(e);let n=o.app.workspace.on("active-leaf-change",e);o.registerEvent(n)}var H=class extends ft.Plugin{canvasManager;settings;async onload(){await this.loadSettings(),this.canvasManager=new B(this.app,this.settings.dateSettings,this.settings.layoutConfig),this.addSettingTab(new q(this.app,this)),this.registerView(L,t=>new $(t,this)),this.addRibbonIcon("list","Open Storyboard Inspector",()=>{this.activateInspectorView()}),pt(this),this.addCommand({id:"storyboard-set-date",name:"Set story date on current note",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||new P(this,e).open(),!0)}}),this.addCommand({id:"storyboard-set-arc",name:"Set story arc on current note",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||new X(this,e).open(),!0)}}),this.addCommand({id:"storyboard-tag-scene",name:"Tag scene (set date + arc)",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||st(this,e),!0)}}),this.addCommand({id:"storyboard-build",name:"Build storyboard (sort + connect + cross-link)",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.buildStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sort",name:"Sort storyboard by date",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.sortStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-connect",name:"Connect scenes chronologically",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectChronologically(e),!0):!1}}),this.addCommand({id:"storyboard-crosslink",name:"Add cross-link edges from [[wikilinks]]",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectByLinks(e),!0):!1}}),this.addCommand({id:"storyboard-play",name:"Play storyboard",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.playStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sync",name:"Sync canvas to notes",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.syncStoryboard(e),!0):!1}})}async loadSettings(){this.settings=Object.assign({},lt,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.canvasManager&&(this.canvasManager.dateSettings=this.settings.dateSettings,this.canvasManager.layoutConfig=this.settings.layoutConfig)}async activateInspectorView(){let{workspace:t}=this.app,e=null,n=t.getLeavesOfType(L);n.length>0?e=n[0]:(e=t.getRightLeaf(!1),e&&await e.setViewState({type:L,active:!0})),e&&t.revealLeaf(e)}onunload(){}};
