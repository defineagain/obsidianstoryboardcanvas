var H=Object.defineProperty;var ft=Object.getOwnPropertyDescriptor;var mt=Object.getOwnPropertyNames;var ht=Object.prototype.hasOwnProperty;var L=(r,t)=>()=>(r&&(t=r(r=0)),t);var Z=(r,t)=>{for(var e in t)H(r,e,{get:t[e],enumerable:!0})},yt=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of mt(t))!ht.call(r,a)&&a!==e&&H(r,a,{get:()=>t[a],enumerable:!(n=ft(t,a))||n.enumerable});return r};var vt=r=>yt(H({},"__esModule",{value:!0}),r);var F,x,P=L(()=>{F={layoutMode:"absolute",xScale:10,arcSpacing:500,nodeWidth:400,nodeHeight:300,nodeGapX:50},x={dateParserRegex:"(?<y>-?\\d+)[-/.](?<M>\\d+)[-/.](?<d>\\d+)",dateParserGroupPriority:"y,M,d",dateDisplayFormat:"{y}-{M}-{d}",dateTokenConfiguration:[{name:"y",type:"NUMBER",minLeght:4,displayWhenZero:!0,hideSign:!1,formatting:[]},{name:"M",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]},{name:"d",type:"NUMBER",minLeght:2,displayWhenZero:!0,hideSign:!0,formatting:[]}],applyAdditonalConditionFormatting:!1}});function bt(r){return r.type==="NUMBER"}function Ct(r){return r.type==="STRING"}function Dt(r,t,e){switch(r){case"GREATER":return t>e;case"LESS":return t<e;case"EQUAL":return t===e;case"NOTEQUAL":return t!==e;case"GREATEROREQUAL":return t>=e;case"LESSOREQUAL":return t<=e;default:return!1}}function wt(r,t){let e=t.minLeght<0?0:t.minLeght,n=Math.abs(r).toString();for(;n.length<e;)n="0"+n;return!t.hideSign&&r<0&&(n=`-${n}`),n}function xt(r,t){return t.dictionary[r]??String(r)}function Tt(r,t){if(bt(t))return wt(r,t);if(Ct(t))return xt(r,t);throw new Error("[Storyflow] Corrupted date token configuration")}function Et(r,t,e,n){return n?e.formatting.reduce((a,o)=>(o.conditionsAreExclusive?o.evaluations.some.bind(o.evaluations):o.evaluations.every.bind(o.evaluations))(({condition:c,value:u})=>Dt(c,t,u))?o.format.replace("{value}",a):a,r):r}function C(r,t){let e=t.dateParserGroupPriority.split(","),n=t.dateDisplayFormat.toString();return e.forEach((a,o)=>{let s=a.trim(),d=t.dateTokenConfiguration.find(({name:c})=>c===s);if(!d)throw new Error(`[Storyflow] No date token configuration found for "${s}"`);n=n.replace(`{${s}}`,Et(Tt(r[o],d),r[o],d,t.applyAdditonalConditionFormatting))}),n}var G=L(()=>{P()});function M(r,t){let e=Math.max(r.length,t.length);for(let n=0;n<e;n++){let a=r[n]??0,o=t[n]??0;if(a!==o)return a-o}return 0}function At(r){let t=[1,30,365,365e3,365e6],e=0;for(let n=0;n<r.length;n++){let a=r.length-1-n,o=t[a]??Math.pow(10,a+2);e+=(r[n]??0)*o}return e}function nt(r,t=F){let e=new Map;if(r.length===0)return e;let n=[...r].sort((c,u)=>M(c.date,u.date)),a=n.map(c=>At(c.date)),o=Math.min(...a),s=[];for(let c of n)s.includes(c.arc)||s.push(c.arc);let d=new Map;for(let c=0;c<n.length;c++){let u=n[c],l=s.indexOf(u.arc),i;if(t.layoutMode==="ordered")i=c*(t.nodeWidth+t.nodeGapX*2);else{i=(a[c]-o)*t.xScale;let p=d.get(u.arc);if(p!==void 0){let f=p+t.nodeWidth+t.nodeGapX;i<f&&(i=f)}d.set(u.arc,i)}let g=l*t.arcSpacing;e.set(u.nodeId,{x:i,y:g})}return e}var K=L(()=>{P()});async function T(r,t,e,n){await r.fileManager.processFrontMatter(t,a=>{a[e]=n})}function Mt(r,t){let e=new Set,n=r.vault.getMarkdownFiles();for(let a of n){let o=r.metadataCache.getFileCache(a);if(!o?.frontmatter)continue;let s=o.frontmatter[t];typeof s=="string"&&s.trim()&&e.add(s.trim())}return[...e].sort()}function at(r,t){new I(r,t,()=>{new $(r,t).open()}).open()}var b,I,$,O=L(()=>{b=require("obsidian");I=class extends b.Modal{file;onComplete;value;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n;let a=t.app.metadataCache.getFileCache(e);this.value=a?.frontmatter?.["story-date"]?.toString()??""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:`Set date: ${this.file.basename}`}),new b.Setting(t).setName("Story date").setDesc("Format: YYYY-MM-DD (e.g. 2024-06-15) or fantasy format").addText(e=>{e.setPlaceholder("1000-03-15").setValue(this.value).onChange(n=>{this.value=n}),e.inputEl.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),this.save())}),setTimeout(()=>e.inputEl.focus(),50)}),new b.Setting(t).addButton(e=>e.setButtonText("Save").setCta().onClick(()=>this.save()))}async save(){let t=this.value.trim();if(!t){new b.Notice("Date cannot be empty.");return}let e=this.plugin.settings.dateSettings.dateParserRegex;if(!new RegExp(e).test(t)){new b.Notice(`Invalid date format. Needs to match regex:
${e}`);return}await T(this.app,this.file,"story-date",t),new b.Notice(`Set story-date: ${t}`),this.close(),this.onComplete()}onClose(){this.contentEl.empty()}},$=class extends b.SuggestModal{file;onComplete;plugin;constructor(t,e,n=()=>{}){super(t.app),this.plugin=t,this.file=e,this.onComplete=n,this.setPlaceholder("Type an arc name or select existing..."),this.setInstructions([{command:"\u2191\u2193",purpose:"navigate"},{command:"\u21B5",purpose:"select or create new"},{command:"esc",purpose:"cancel"}])}getSuggestions(t){let e=Mt(this.app,"story-arc"),n=t.toLowerCase().trim(),a=e.filter(o=>o.toLowerCase().includes(n));return n&&!e.some(o=>o.toLowerCase()===n)&&a.unshift(`+ Create "${t.trim()}"`),a.length>0?a:[`+ Create "${t.trim()||"default"}"`]}renderSuggestion(t,e){e.createEl("span",{text:t})}async onChooseSuggestion(t){let e=t,n=t.match(/^\+ Create "(.+)"$/);n&&(e=n[1]),await T(this.app,this.file,"story-arc",e),new b.Notice(`Set story-arc: ${e}`),this.onComplete()}}});var ot={};Z(ot,{SyncConfirmationModal:()=>Q,calculateSyncChanges:()=>It});async function It(r,t,e,n,a){let o=[],s=new Map;for(let l of e){let i=t.nodes.get(l.nodeId);!i||(s.has(l.arc)||s.set(l.arc,[]),s.get(l.arc).push(i.getData().y))}let d=new Map;for(let[l,i]of s.entries()){let g=i.reduce((p,f)=>p+f,0)/i.length;d.set(l,g)}let u=Array.from(t.nodes.entries()).map(([l,i])=>({id:l,data:i.getData()})).filter(l=>l.data.type==="file"&&l.data.file).sort((l,i)=>l.data.x-i.data.x).map(l=>l.id);for(let l of e){let i=t.nodes.get(l.nodeId);if(!i)continue;let g=i.getData(),p=!1,f,h,S=[],D=l.arc,B=1/0;for(let[y,v]of d.entries()){let z=Math.abs(g.y-v);z<B&&(B=z,D=y)}D!==l.arc&&B<n.arcSpacing/2&&(f=D,S.push(`Arc changed from "${l.arc}" to "${f}"`),p=!0);let j=u.indexOf(l.nodeId),gt=u[j-1],pt=u[j+1],w=e.find(y=>y.nodeId===gt),k=e.find(y=>y.nodeId===pt),q=!1;if(w&&M(l.date,w.date)<=0&&(q=!0),k&&M(l.date,k.date)>=0&&(q=!0),q){let y=[...l.date],v=y.length-1;w&&k?(y[v]=Math.floor((w.date[v]+k.date[v])/2),y[v]<=w.date[v]&&(y[v]=w.date[v]+1)):w?y[v]=w.date[v]+1:k&&(y[v]=k.date[v]-1),h=y,S.push(`Sequence moved: expected bounds broken. Suggesting new date: ${C(h,a)}`),p=!0}p&&o.push({scene:l,newArc:f,newDate:h,description:S.join("; ")})}return o}var N,Q,rt=L(()=>{N=require("obsidian");G();K();O();Q=class extends N.Modal{changes;dateSettings;onConfirm;constructor(t,e,n,a){super(t),this.changes=e,this.dateSettings=n,this.onConfirm=a}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:`Sync ${this.changes.length} Changes to Notes`}),t.createEl("p",{text:"The following frontmatter updates will be applied based on your canvas dragging:"});let e=t.createEl("ul",{cls:"storyflow-sync-list"});for(let n of this.changes){let a=e.createEl("li");a.createEl("strong",{text:n.scene.title+": "}),a.createEl("span",{text:n.description})}new N.Setting(t).addButton(n=>n.setButtonText("Cancel").onClick(()=>this.close())).addButton(n=>n.setButtonText("Apply Changes").setCta().onClick(async()=>{this.close();let a=0;for(let o of this.changes){if(o.newArc&&await T(this.app,o.scene.file,"story-arc",o.newArc),o.newDate){let s=C(o.newDate,this.dateSettings);await T(this.app,o.scene.file,"story-date",s)}a++}new N.Notice(`Successfully synced ${a} notes from canvas.`),this.onConfirm()}))}onClose(){this.contentEl.empty()}}});var Ft={};Z(Ft,{default:()=>W});module.exports=vt(Ft);var ut=require("obsidian");var m=require("obsidian");P();function J(r,t,e){if(!!r.frontmatter)return typeof r.frontmatter[t]===e?r.frontmatter[t]:void 0}function St(r,t,e){try{let n=new RegExp(e).exec(t);if(!n?.groups)return;let a=[];for(let o of r){let s=n.groups[o.trim()];if(s===void 0)return;let d=parseInt(s,10);if(isNaN(d))return;a.push(d)}return a}catch{return}}function R(r,t,e){if(!r.frontmatter)return;let n=r.frontmatter[t];if(n==null)return;let a=e.dateParserGroupPriority.split(",");if(typeof n=="number"){let g=[...Array(Math.max(0,a.length-1))].map(()=>1);return[n,...g]}if(n instanceof Date)return[n.getFullYear(),n.getMonth()+1,n.getDate()];if(typeof n=="object"&&typeof n.toISOString=="function")try{let g=new Date(n.toISOString());return[g.getFullYear(),g.getMonth()+1,g.getDate()]}catch{}let o;typeof n=="string"?o=n.trim():o=String(n).trim();let s=o.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);if(s)return[parseInt(s[1],10),parseInt(s[2],10),parseInt(s[3],10)];let d=o.match(/^(-?\d+)\/(\d{1,2})\/(\d{1,2})/);if(d)return[parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10)];let c=o.match(/^(-?\d+)\.(\d{1,2})\.(\d{1,2})/);if(c)return[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)];let u=o.match(/\w+ (\w+) (\d+) (\d{4})/);if(u){let p={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[u[1]];if(p)return[parseInt(u[3],10),p,parseInt(u[2],10)]}let l=o.replace(/[/.]/g,"-"),i=St(a,l,e.dateParserRegex);if(i)return i;console.warn(`[Storyboard Canvas] Could not parse '${t}' value:`,n,`(type: ${typeof n})`)}function tt(r,t="story-arc"){return J(r,t,"string")??"default"}function et(r,t="story-title"){return J(r,t,"string")??""}G();K();function st(r=16){return Math.random().toString(36).substring(2,2+r/2)+Math.random().toString(36).substring(2,2+r/2)}var U=class{app;dateSettings;layoutConfig;constructor(t,e=x,n=F){this.app=t,this.layoutConfig=n,this.dateSettings=e}getActiveCanvas(){let t=this.app.workspace.activeLeaf;if(!t)return null;let e=t.view;return e?.getViewType?.()!=="canvas"?null:e.canvas??null}async extractScenes(t){let e=[];for(let[n,a]of t.nodes){let o=a.getData();if(o.type!=="file"||!o.file)continue;let s=this.app.vault.getAbstractFileByPath(o.file);if(!(s instanceof m.TFile))continue;let d=this.app.metadataCache.getFileCache(s);if(!d){console.warn(`[Storyboard] No metadata cache for: ${s.path}`);continue}let c=d.frontmatter?.["story-date"];if(c==null){console.log(`[Storyboard] Skipping ${s.basename}: no story-date in frontmatter`);continue}console.log(`[Storyboard] ${s.basename}: story-date raw =`,c,`(type: ${typeof c}, isDate: ${c instanceof Date})`);let u=R(d,"story-date",this.dateSettings);if(!u){console.warn(`[Storyboard] FAILED to parse story-date for: ${s.basename}, raw value:`,c);continue}let l=R(d,"story-end-date",this.dateSettings),i=tt(d),g=et(d)||s.basename;console.log(`[Storyboard] \u2713 ${s.basename}: date=[${u}], arc="${i}"`),e.push({nodeId:n,file:s,date:u,endDate:l,arc:i,title:g})}return e}async sortStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new m.Notice("No scenes with story-date found on this canvas.");return}let n=nt(e,this.layoutConfig);for(let[a,o]of n){let s=t.nodes.get(a);if(!s)continue;let d=s.getData();s.setData({...d,x:o.x,y:o.y,width:this.layoutConfig.nodeWidth,height:this.layoutConfig.nodeHeight})}t.requestSave(),new m.Notice(`Sorted ${e.length} scenes by date.`)}async connectChronologically(t){let e=await this.extractScenes(t);if(e.length<2){new m.Notice("Need at least 2 scenes with story-date to connect.");return}let n=new Map;for(let s of e){let d=n.get(s.arc)??[];d.push(s),n.set(s.arc,d)}let a=0,o=t.getData();for(let[,s]of n){s.sort((d,c)=>M(d.date,c.date));for(let d=0;d<s.length-1;d++){let c=s[d],u=s[d+1];if(o.edges.some(g=>g.fromNode===c.nodeId&&g.toNode===u.nodeId))continue;let i=C(u.date,this.dateSettings);o.edges.push({id:st(),fromNode:c.nodeId,toNode:u.nodeId,fromSide:"right",toSide:"left",toEnd:"arrow",label:i}),a++}}a>0&&(t.setData(o),t.requestSave()),new m.Notice(`Connected ${a} scene pairs across ${n.size} arc(s).`)}async connectByLinks(t){let e=this.app.metadataCache.resolvedLinks,n=t.getData(),a=new Map;for(let[d,c]of t.nodes){let u=c.getData();u.type==="file"&&u.file&&a.set(u.file,d)}let o=new Set;for(let d of n.edges)o.add(`${d.fromNode}->${d.toNode}`);let s=0;for(let[d,c]of a){let u=e[d];if(!!u)for(let l in u){let i=a.get(l);if(!i||i===c)continue;let g=`${c}->${i}`;o.has(g)||(n.edges.push({id:st(),fromNode:c,toNode:i,fromSide:"bottom",toSide:"top",toEnd:"arrow",styleAttributes:{"edge-style":"dotted"}}),o.add(g),s++)}}s>0&&(t.setData(n),t.requestSave()),new m.Notice(`Created ${s} cross-link edges from [[wikilinks]].`)}async buildStoryboard(t){let e=t.nodes.size,n=await this.extractScenes(t),a=e-n.length;if(n.length===0){new m.Notice(`No scenes found. ${e} nodes on canvas but none have story-date frontmatter. Use "Tag scene" command on each note first.`);return}a>0&&new m.Notice(`Found ${n.length} tagged scenes (${a} nodes skipped \u2014 no story-date).`),this.removeMarkerNodes(t),await this.sortStoryboard(t),await this.connectChronologically(t),await this.connectByLinks(t),this.addVisualMarkers(t,n),new m.Notice(`Storyboard built: ${n.length} scenes, sorted + connected + labelled.`)}MARKER_PREFIX="storyboard-marker-";removeMarkerNodes(t){let e=t.getData();e.nodes=e.nodes.filter(n=>!n.id?.startsWith(this.MARKER_PREFIX)),t.setData(e),t.requestSave()}addVisualMarkers(t,e){let n=t.getData(),a=new Map,o=new Map;for(let f of e){let h=t.nodes.get(f.nodeId);if(!h)continue;let S=h.getData();a.has(f.arc)||a.set(f.arc,S.y);let D=C(f.date,this.dateSettings);o.has(D)||o.set(D,S.x)}let s=200,d=60,c=Math.min(...a.values())-d-80,l=Math.min(...o.values())-s-60,i=0;for(let[f,h]of a){let S=["1","2","3","4","5","6"];n.nodes.push({id:`${this.MARKER_PREFIX}arc-${i}`,type:"text",text:`## ${f}`,x:l,y:h+this.layoutConfig.nodeHeight/2-d/2,width:s,height:d,color:S[i%S.length]}),i++}let g=0;for(let[f,h]of o)n.nodes.push({id:`${this.MARKER_PREFIX}date-${g}`,type:"text",text:`**${f}**`,x:h+this.layoutConfig.nodeWidth/2-s/2,y:c,width:s,height:d,color:"0"}),g++;let p=40;for(let f of e){let h=t.nodes.get(f.nodeId);if(!h)continue;let S=h.getData(),D=C(f.date,this.dateSettings);n.nodes.push({id:`${this.MARKER_PREFIX}nodelabel-${f.nodeId}`,type:"text",text:D,x:S.x,y:S.y-p-10,width:this.layoutConfig.nodeWidth,height:p,color:"0"})}t.setData(n),t.requestSave()}async syncStoryboard(t){let e=await this.extractScenes(t);if(e.length===0){new m.Notice("No scenes with story-date found.");return}let{calculateSyncChanges:n,SyncConfirmationModal:a}=await Promise.resolve().then(()=>(rt(),ot)),o=await n(this.app,t,e,this.layoutConfig,this.dateSettings);if(o.length===0){new m.Notice("No drag-and-drop changes detected.");return}new a(this.app,o,this.dateSettings,()=>{this.buildStoryboard(t)}).open()}async playStoryboard(t,e=1500){let n=await this.extractScenes(t);if(n.length===0){new m.Notice("No scenes with story-date found.");return}n.sort((a,o)=>M(a.date,o.date)),new m.Notice(`Playing ${n.length} scenes...`);for(let a of n){let o=t.nodes.get(a.nodeId);if(!o)continue;let s=o.getData();t.zoomToBbox({minX:s.x-50,minY:s.y-50,maxX:s.x+s.width+50,maxY:s.y+s.height+50}),await new Promise(d=>setTimeout(d,e))}new m.Notice("Playback complete.")}};O();var E=require("obsidian");P();var it={layoutConfig:F,dateSettings:x},X=class extends E.PluginSettingTab{plugin;constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Storyboard Canvas Settings"}),new E.Setting(t).setName("Layout Mode").setDesc("Absolute: position nodes strictly by time elapsed on X-axis. Ordered: distribute nodes evenly in sequence on X-axis.").addDropdown(e=>e.addOption("absolute","Absolute Time Graph").addOption("ordered","Ordered Sequence").setValue(this.plugin.settings.layoutConfig.layoutMode).onChange(async n=>{this.plugin.settings.layoutConfig.layoutMode=n,await this.plugin.saveSettings()})),new E.Setting(t).setName("Date Parser Regex").setDesc("Regex with named capture groups (?<y>, ?<M>, ?<d>) to extract dates from story-date.").addText(e=>e.setPlaceholder(x.dateParserRegex).setValue(this.plugin.settings.dateSettings.dateParserRegex).onChange(async n=>{this.plugin.settings.dateSettings.dateParserRegex=n.trim()||x.dateParserRegex,await this.plugin.saveSettings()})),new E.Setting(t).setName("Date Display Format").setDesc("How dates appear on canvas labels. Use {y}, {M}, {d}.").addText(e=>e.setPlaceholder(x.dateDisplayFormat).setValue(this.plugin.settings.dateSettings.dateDisplayFormat).onChange(async n=>{this.plugin.settings.dateSettings.dateDisplayFormat=n.trim()||x.dateDisplayFormat,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Layout Dimensions"}),new E.Setting(t).setName("X Scale (Absolute Mode)").setDesc("Pixels per date ordinal unit in absolute time graph mode.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.xScale)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.xScale=a,await this.plugin.saveSettings())})),new E.Setting(t).setName("Arc Lane Spacing (Y-Axis)").setDesc("Pixels between arc lanes on the Y-axis.").addText(e=>e.setValue(String(this.plugin.settings.layoutConfig.arcSpacing)).onChange(async n=>{let a=parseInt(n,10);isNaN(a)||(this.plugin.settings.layoutConfig.arcSpacing=a,await this.plugin.saveSettings())}))}};var A=require("obsidian");G();O();var _="storyboard-inspector-view",Y=class extends A.ItemView{plugin;pollInterval=null;activeNodeId=null;container;contentDiv;constructor(t,e){super(t),this.plugin=e}getViewType(){return _}getDisplayText(){return"Storyboard Inspector"}getIcon(){return"list"}async onOpen(){let{containerEl:t}=this;t.empty(),t.addClass("storyboard-inspector-view"),t.createEl("h3",{text:"Storyboard Inspector"}),this.container=t.createDiv({cls:"inspector-content"}),this.renderEmptyState(),this.pollInterval=window.setInterval(()=>this.pollSelection(),300)}async onClose(){this.pollInterval!==null&&(window.clearInterval(this.pollInterval),this.pollInterval=null)}renderEmptyState(){this.container.empty(),this.container.createEl("p",{text:"Select a single file node on the canvas to inspect it.",cls:"empty-state"}),this.activeNodeId=null}pollSelection(){let t=this.plugin.canvasManager.getActiveCanvas();if(!t){this.activeNodeId!==null&&this.renderEmptyState();return}let e=Array.from(t.selection);if(e.length!==1){this.activeNodeId!==null&&this.renderEmptyState();return}let n=e[0];if(n.getData().type!=="file"||!n.file){this.activeNodeId!==null&&this.renderEmptyState();return}let a=n.getData().id;this.activeNodeId!==a&&(this.activeNodeId=a,this.renderInspector(n))}async renderInspector(t){if(this.container.empty(),!t.file)return;this.container.createEl("h4",{text:t.file.basename});let e=this.app.metadataCache.getFileCache(t.file),n=e?.frontmatter||{},a=n["story-arc"]?.toString()||"",o=n["story-date"]?.toString()||"",s=R(e,"story-date",this.plugin.settings.dateSettings);s&&(o=C(s,this.plugin.settings.dateSettings)),new A.Setting(this.container).setName("Story Arc").setDesc("Which lane or plotline this scene belongs to.").addText(i=>{i.setValue(a).setPlaceholder("e.g. Main Plot");let g=async()=>{let p=i.getValue();p!==a&&await T(this.app,t.file,"story-arc",p)};i.inputEl.addEventListener("blur",g),i.inputEl.addEventListener("keydown",p=>{p.key==="Enter"&&(g(),i.inputEl.blur())})}),new A.Setting(this.container).setName("Story Date").setDesc("Format must match plugin settings regex.").addText(i=>{i.setValue(o).setPlaceholder("YYYY-MM-DD");let g=async()=>{let p=i.getValue();if(p!==o){let f=this.plugin.settings.dateSettings.dateParserRegex;new RegExp(f).test(p)?await T(this.app,t.file,"story-date",p):new A.Notice("Invalid date format for Storyboard")}};i.inputEl.addEventListener("blur",g),i.inputEl.addEventListener("keydown",p=>{p.key==="Enter"&&(g(),i.inputEl.blur())})}),this.container.createEl("h4",{text:"Timeline Nudge",cls:"timeline-slider-header"}),this.container.createEl("p",{text:"Slide left/right to move the node on the timeline. Release to sync changes to frontmatter.",cls:"setting-item-description"});let c=this.container.createDiv({cls:"timeline-slider-container"}).createEl("input");c.type="range";let u=t.x;c.min=(u-1e3).toString(),c.max=(u+1e3).toString(),c.value=u.toString();let l=this.plugin.canvasManager.getActiveCanvas();c.addEventListener("input",()=>{let i=parseInt(c.value,10);t.setData({...t.getData(),x:i}),l.requestSave()}),c.addEventListener("change",async()=>{let i=t.x;c.min=(i-1e3).toString(),c.max=(i+1e3).toString(),c.value=i.toString(),new A.Notice("Calculating new date from slider position..."),await this.plugin.canvasManager.syncStoryboard(l)})}};var ct=require("obsidian");O();var V=null;function dt(r){V||(V=window.setInterval(()=>{let t=document.body.querySelector(".canvas-node-menu");t&&kt(t,r)},250))}function lt(){V!==null&&(window.clearInterval(V),V=null)}function kt(r,t){let e=t.canvasManager.getActiveCanvas();if(!e)return;let n=Array.from(e.selection);if(n.length!==1)return;let a=n[0];if(a.getData().type!=="file"||!a.file||r.querySelector(".storyboard-menu-btn"))return;let o=document.createElement("button");o.addClass("clickable-icon"),o.addClass("canvas-node-menu-item"),o.addClass("storyboard-menu-btn"),o.setAttribute("aria-label","Set story-date"),(0,ct.setIcon)(o,"calendar"),o.addEventListener("click",()=>{new I(t,a.file).open()}),r.appendChild(o)}var W=class extends ut.Plugin{canvasManager;settings;async onload(){console.log("[Storyboard Canvas] v0.4.3 - Plugin loading started..."),await this.loadSettings(),this.canvasManager=new U(this.app,this.settings.dateSettings,this.settings.layoutConfig),this.addSettingTab(new X(this.app,this)),console.log("[Storyboard Canvas] Settings Tab registered."),console.log("[Storyboard Canvas] Registering Inspector View..."),this.registerView(_,t=>new Y(t,this)),console.log("[Storyboard Canvas] Adding Ribbon Icon..."),this.addRibbonIcon("list","Open Storyboard Inspector",()=>{this.activateInspectorView()}),console.log("[Storyboard Canvas] Installing Canvas Menu Extension..."),dt(this),console.log("[Storyboard Canvas] UI Enhancements successfully loaded."),this.addCommand({id:"storyboard-set-date",name:"Set story date on current note",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||new I(this,e).open(),!0)}}),this.addCommand({id:"storyboard-set-arc",name:"Set story arc on current note",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||new $(this,e).open(),!0)}}),this.addCommand({id:"storyboard-tag-scene",name:"Tag scene (set date + arc)",checkCallback:t=>{let e=this.app.workspace.getActiveFile();return!e||e.extension!=="md"?!1:(t||at(this,e),!0)}}),this.addCommand({id:"storyboard-build",name:"Build storyboard (sort + connect + cross-link)",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.buildStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sort",name:"Sort storyboard by date",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.sortStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-connect",name:"Connect scenes chronologically",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectChronologically(e),!0):!1}}),this.addCommand({id:"storyboard-crosslink",name:"Add cross-link edges from [[wikilinks]]",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.connectByLinks(e),!0):!1}}),this.addCommand({id:"storyboard-play",name:"Play storyboard",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.playStoryboard(e),!0):!1}}),this.addCommand({id:"storyboard-sync",name:"Sync canvas to notes",checkCallback:t=>{let e=this.canvasManager.getActiveCanvas();return e?(t||this.canvasManager.syncStoryboard(e),!0):!1}})}async loadSettings(){this.settings=Object.assign({},it,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.canvasManager&&(this.canvasManager.dateSettings=this.settings.dateSettings,this.canvasManager.layoutConfig=this.settings.layoutConfig)}async activateInspectorView(){let{workspace:t}=this.app,e=null,n=t.getLeavesOfType(_);n.length>0?e=n[0]:(e=t.getRightLeaf(!1),e&&await e.setViewState({type:_,active:!0})),e&&t.revealLeaf(e)}onunload(){lt()}};
